---
title: "ms_figures"
author: "Jessica Gephart"
date: "2022-08-15"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
library(tidyverse)
library(countrycode)
library(circlize)
library(here)
library(ggpubr)
library(kableExtra)
library(DBI)
library(janitor)
library(viridis)
library(broom)
library(exploreARTIS)
library(vegan)
library(tidytext)
library(cowplot)
library(scales)
library(ggsankey)
library(ggpubr)
library(rnaturalearth)
library(CoordinateCleaner)
```

```{r load_data}
# Set directories
datadir <- "qa/manuscript_archive/manuscript_inputs"
outdir <- "qa/manuscript_archive/figures"
```

```{r color_palettes}
# Set color palettes
# All colors from palette: #FFE6BE (light yellow), #F7AF75 (light orange), #F37542 (medium orange), 
# #E24027 (dark orange), #0F2D59 (navy), #1B708F (blue), #2E8D9A (teal), #86ADA7 (light blue)
method_colors <- c("#F7AF75", "#2E8D9A", "#86ADA7") # light orange, teal, light blue
source_colors <- c("#F37542", "#0F2D59", "#86ADA7") # medium orange, navy, light blue
environment_colors <- c( "#2E8D9A", "#0F2D59","#86ADA7") # teal, navy, light blue

habitat_source_colors <- c("#1B708F", # blue = marine capture
                          "#86ADA7", # light blue = freshwater capture
                          "#F37542", # medium orange = marine aquaculture
                          "#F7AF75", # light orange = inland aquaculture
                          "grey50" # unknown
                          )

region_colors <- c(
  "#741A32", # maroon
  "#B34232", # burnt orange
  "#D38F35", #  orange
  "#D4B95f", # khaki
  "#4FA2A2", # teal
  "#114F59" # dark teal
)

region6_palette <- c(
  "#741A32", # maroon
  "#B34232", # burnt orange
  "#D38F35", #  orange
  "#D4B95F", # khaki
  "#4FA2A2", # teal
  "#114F59" # dark teal
)

```

# Figure 1: Increases in global export of blue foods

## Figure 1 a: Exports of global marine and freshwater aquaculture and fishery products (t live weight equivalent) from 1996-2019

```{r fig1a}
fig1a_data <- read.csv(file.path(datadir, "fig_1a_data.csv"))

fig1a <- fig1a_data %>%
  mutate(habitat_method = factor(habitat_method, 
                                 levels = c("marine capture", "inland capture", 
                                            "marine aquaculture", "inland aquaculture", "unknown"))) %>%
  ggplot(aes(x = year, y = live_weight_t/1000000, fill = habitat_method)) +
  geom_area() +
  scale_fill_manual(values = habitat_source_colors) +
  labs(y = "Exports\n(mil. t, live weight)", fill = "Source", x = "") +
  theme_bw() +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        axis.title.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        legend.title = element_text(size = 7),
        legend.text = element_text(size = 6)
        )

fig1a
```


## Figure 1 b: Percent of global marine and freshwater aquaculture and fishery production exported, excluding re-exports

```{r fig1b}
fig1b_data <- read.csv(file.path(datadir, "fig_1b_data.csv")) %>%
    mutate(habitat_method = factor(habitat_method, 
                                 levels = c("marine capture", "inland capture", 
                                            "marine aquaculture", "inland aquaculture", "unknown"))) 

fig1b <- ggplot() +
  geom_line(data = fig1b_data, aes(x = year, y = percent_export, color = habitat_method)) +
  scale_color_manual(values = habitat_source_colors) +
  labs(y = "% Production\nexported", x = "", color = "Source") +
  theme_bw() +
  theme(
    text = element_text(size = 10),
    legend.title = element_text(size = 7),
    legend.text = element_text(size = 6)
  )

fig1b
```


## Figure 1c: Degree or measure of degree distribution by production method and environment

```{r fig1c}
fig1c_data <- read.csv(file.path(datadir, "fig_1c_data.csv"))

fig1c_out_degree <- fig1c_data %>%
    mutate(habitat_method = factor(habitat_method, 
                                 levels = c("marine capture", "inland capture", 
                                            "marine aquaculture", "inland aquaculture", "unknown"))) %>%
  ggplot(aes(x = year, y = all_in_degree, color = habitat_method)) +
  geom_smooth(alpha = 0.2) +
  scale_color_manual(values = habitat_source_colors) +
  labs(y = "Average\nno. export partners", color = "Source") + 
  theme_bw() +
  theme(
    text = element_text(size = 10),
    axis.title.x = element_blank(),
    legend.title = element_text(size = 7),
    legend.text = element_text(size = 6)
  )

fig1c_out_degree
```

```{r fig1de}
habitat_source_colors_v2 <- c("#F7AF75", # light orange = inland aquaculture
                              "#86ADA7", # light blue = freshwater capture
                              "#F37542", # medium orange = marine aquaculture
                              "#1B708F", # blue = marine capture
                              "black" # unknown
                          )

# Concentration of trade by production source, measured as the number of countries comprising 75%
cumulative_percent_threshold <- 75

export_n_countries_concentration <- read.csv(file.path(datadir, "export_concentration_n_countries.csv"))
import_n_countries_concentration <- read.csv(file.path(datadir, "import_concentration_n_countries.csv"))

export_n_countries_concentration_by_source <- read.csv(file.path(datadir, "export_concentration_n_countries_by_source.csv"))  
import_n_countries_concentration_by_source <- read.csv(file.path(datadir, "import_concentration_n_countries_by_source.csv"))  %>% 
      mutate(habitat_method = factor(habitat_method, 
                                 levels = c("marine capture", "inland capture", 
                                            "marine aquaculture", "inland aquaculture"))) 

fig1d <- ggplot() +
  geom_line(data = export_n_countries_concentration_by_source %>% 
      mutate(habitat_method = factor(habitat_method, 
                                 levels = c("marine capture", "inland capture", 
                                            "marine aquaculture", "inland aquaculture"))), 
      aes(x = year, y = n, color = habitat_method)) +
  geom_line(data = export_n_countries_concentration, aes(x = year, y = n, color = "total"), linewidth = 1) +
  scale_color_manual(values = habitat_source_colors_v2) +
  labs(x = "", y = paste("No. countries\ncomprising ", cumulative_percent_threshold, "% exports", sep = ""), color = "Source") +
  lims(y = c(0, 30)) +
  theme_bw() +
  theme(
    text = element_text(size = 10),
    legend.title = element_text(size = 7),
    legend.text = element_text(size = 6)
  )

fig1d

fig1e <- ggplot() +
  geom_line(data = import_n_countries_concentration_by_source %>% 
              mutate(habitat_method = factor(habitat_method, 
                                 levels = c("marine capture", "inland capture", 
                                            "marine aquaculture", "inland aquaculture", "unknown"))), 
      aes(x = year, y = n, color = habitat_method)) +
  geom_line(data = import_n_countries_concentration, aes(x = year, y = n, color = "total"), linewidth = 1) +
    scale_color_manual(values = habitat_source_colors_v2) +
  labs(x = "", y = paste("No. countries\ncomprising ", cumulative_percent_threshold, "% imports", sep = ""), color = "Source") +
  lims(y = c(0, 30)) +
  theme_bw() +
  theme(
    text = element_text(size = 10),
    legend.title = element_text(size = 7),
    legend.text = element_text(size = 6)
  )

fig1e
```

```{r fig1, fig.height = 6, fig.width = 6}
ggarrange(fig1a,
          ggarrange(fig1b,
                    fig1c_out_degree,
                    ncol = 2, nrow = 1,
                    legend = "none",
                    labels = c("b", "c")),
          ggarrange(fig1d,
                    fig1e,
                    ncol = 2, nrow = 1,
                    legend = "none",
                    labels = c("d", "e")),
          common.legend = TRUE, legend = "bottom",
          ncol = 1, nrow = 3, labels = c("a", ""))

# ggsave(file.path(outdir, "fig1.png"))
ggsave(file.path(outdir, "fig1.pdf"), device = "pdf", height = 150, width = 180, units = "mm")
```

# Figure 2: Foreign consumption trends
```{r foreign_consumption_setup}
marine_cap_foreign_consumption <- read.csv(file.path(datadir, "marine_capture_foreign_consumption.csv"))

marine_aqua_foreign_consumption <- read.csv(file.path(datadir, "marine_aquaculture_foreign_consumption.csv"))

inland_cap_foreign_consumption <- read.csv(file.path(datadir, "inland_capture_foreign_consumption.csv"))

inland_aqua_foreign_consumption <- read.csv(file.path(datadir, "inland_aquaculture_foreign_consumption.csv"))

marine_cap_sciname <- read.csv(file.path(datadir, "marine_capture_top_scinames_foreign_consumption.csv"))

marine_aqua_sciname <- read.csv(file.path(datadir, "marine_aquaculture_top_scinames_foreign_consumption.csv"))

inland_cap_sciname <- read.csv(file.path(datadir, "inland_capture_top_scinames_foreign_consumption.csv"))

inland_aqua_sciname <- read.csv(file.path(datadir, "inland_aquaculture_top_scinames_foreign_consumption.csv"))

# Load world map data
world <- ne_countries(scale = "medium", returnclass = "sf") %>%
  filter(iso_a3 != "ATA")

consumer_map_df <- marine_cap_foreign_consumption %>%
  mutate(habitat_method = "Marine Capture") %>%
  bind_rows(marine_aqua_foreign_consumption %>%
              mutate(habitat_method = "Marine Aquaculture")) %>%
  bind_rows(inland_cap_foreign_consumption %>%
              mutate(habitat_method = "Inland Capture")) %>%
  bind_rows(inland_aqua_foreign_consumption %>%
              mutate(habitat_method = "Inland Aquaculture")) %>%
  group_by(consumer_iso3c, habitat_method) %>%
  summarize(consumption_live_t = sum(consumption_live_t, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(
    world,
    by = c("consumer_iso3c"="iso_a3")
  )

country_centroids <- countryref %>%
  filter(str_count(as.character(adm1_code))==3) %>%
  group_by(iso3) %>%
  summarise(centroid.lon = mean(centroid.lon),
            centroid.lat = mean(centroid.lat)) %>%
  ungroup() %>%
  mutate(
    centroid.lon = case_when(
      iso3 == "KIR" ~ 172.9717,
      TRUE ~ centroid.lon
    ),
    centroid.lat = case_when(
      iso3 == "KIR" ~ 1.4518,
      TRUE ~ centroid.lat
    )
  )

trade_map <- ggplot(world) +
  geom_sf(size = 0.1, color = "white", fill = "grey", alpha = 0.5)

# Maximum and minimum limits for maps and stacked bar charts
consumption_live_magnitude <- 1e6

map_min <- 0
map_max <- max(consumer_map_df$consumption_live_t, na.rm = TRUE) / consumption_live_magnitude
arrows_min <- 0
arrows_max <- max(
  c(marine_cap_foreign_consumption$consumption_live_t,
    marine_aqua_foreign_consumption$consumption_live_t,
    inland_cap_foreign_consumption$consumption_live_t,
    inland_aqua_foreign_consumption$consumption_live_t),
  na.rm = TRUE
) / consumption_live_magnitude

sciname_df <- marine_cap_sciname %>%
  mutate(habitat_method = "Marine Capture") %>%
  bind_rows(marine_aqua_sciname %>%
              mutate(habitat_method = "Marine Aquaculture")) %>%
  bind_rows(inland_cap_sciname %>%
              mutate(habitat_method = "Inland Capture")) %>%
  bind_rows(inland_aqua_sciname %>%
              mutate(habitat_method = "Inland Aquaculture")) %>%
  group_by(common_name, flow, habitat_method) %>%
  summarize(consumption_live_t = sum(consumption_live_t, na.rm = TRUE)) %>%
  ungroup()

stacked_bar_min <- 0
stacked_bar_max <- max(
  sciname_df$consumption_live_t,
  na.rm = TRUE
) / consumption_live_magnitude

```

```{r marine_cap_foreign_consumption}

marine_cap_map <- trade_map +
  geom_sf(data = consumer_map_df %>%
            filter(habitat_method == "Marine Capture"), 
          aes(fill = consumption_live_t/consumption_live_magnitude, geometry = geometry), color = "white", size = 0.1) +
  scale_fill_gradient(low = "#86ADA7", high = "#0F2D59", limits=c(map_min, map_max)) +
  theme_bw() + 
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank(),
    panel.spacing = unit(2, "mm"),
    panel.border = element_blank(),
    plot.background = element_blank(),
    plot.margin = unit(c(0,0,-5,0),"mm")
  )

marine_cap_arrows <- marine_cap_foreign_consumption %>%
  slice_max(n = 10, order_by = consumption_live_t) %>%
  # Join with lat/long data for centroids
  left_join(country_centroids, by = c("source_country_iso3c" = "iso3")) %>%
  left_join(country_centroids, by = c("consumer_iso3c" = "iso3")) %>%
  mutate(centroid.lat.x = 1.05 * centroid.lat.x,
         centroid.lat.y = 0.95 * centroid.lat.y)

marine_cap_map <- marine_cap_map +
  geom_curve(data = marine_cap_arrows, 
                 aes(x = centroid.lon.x, y = centroid.lat.x, 
                     xend = centroid.lon.y, yend = centroid.lat.y,
                     color = consumption_live_t/consumption_live_magnitude),
                 size = 1.2,
                 alpha = 0.75,
                 curvature = -0.35, arrow = arrow(length = unit(3, "mm"), angle = 20)) +
      scale_colour_gradient(low = "#F7AF75", high = "#E24027", limits = c(arrows_min, arrows_max))

marine_cap_map

marine_cap_stacked_bar <- marine_cap_sciname %>%
  mutate(common_name = case_when(
    common_name == "alaska pollock(=walleye poll.)" ~ "alaska pollock",
    common_name == "ray-finned fishes" ~ "ray finned fishes",
    TRUE ~ common_name
  )) %>%
  mutate(common_name = gsub(" ", "\n", common_name)) %>%
  mutate(common_name = reorder(common_name, desc(total))) %>%
  ggplot(aes(x = consumption_live_t/consumption_live_magnitude, y = flow, fill = region)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7) +
  scale_fill_manual(values = region6_palette) +
  labs(x = "", y = "") +
  lims(x = c(stacked_bar_min, stacked_bar_max)) +
  facet_grid(vars(common_name), switch = "y") +
  theme_minimal() +
  theme(
    strip.text.y.left = element_text(size = 8),
    strip.placement = "outside",
    legend.position = "none",
    panel.spacing = unit(0.5, "mm"),
    axis.ticks.x = element_blank(),
    axis.text.x = element_blank(),
    # axis.text.y = element_text(size = 8),
    plot.margin = unit(c(0, 5, -5, -10), "mm")
  )

marine_cap_stacked_bar

marine_cap <- ggarrange(
  marine_cap_map, marine_cap_stacked_bar,
  nrow = 1, ncol = 2,
  widths = c(1.5, 1)
)

marine_cap <- annotate_figure(
  marine_cap, top = text_grob("Marine Capture")#, vjust = 1),
)

marine_cap
```

```{r marine_aqua_foreign_consumption}
marine_aqua_map <- trade_map +
  geom_sf(data = consumer_map_df %>%
            filter(habitat_method == "Marine Aquaculture"), 
          aes(fill = consumption_live_t/consumption_live_magnitude, geometry = geometry), color = "white", size = 0.1) +
  scale_fill_gradient(low = "#86ADA7", high = "#0F2D59", limits = c(map_min, map_max)) +
  theme_bw() + 
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank(),
    panel.spacing = unit(2, "mm"),
    panel.border = element_blank(),
    plot.background = element_blank(),
    plot.margin = unit(c(0,0,-5,0),"mm")
  )

marine_aqua_arrows <- marine_aqua_foreign_consumption %>%
  slice_max(n = 10, order_by = consumption_live_t) %>%
  # Join with lat/long data for centroids
  left_join(country_centroids, by = c("source_country_iso3c" = "iso3")) %>%
  left_join(country_centroids, by = c("consumer_iso3c" = "iso3")) %>%
  mutate(centroid.lat.x = 1.05 * centroid.lat.x,
         centroid.lat.y = 0.95 * centroid.lat.y)

marine_aqua_map <- marine_aqua_map +
  geom_curve(data = marine_aqua_arrows, 
                 aes(x = centroid.lon.x, y = centroid.lat.x, 
                     xend = centroid.lon.y, yend = centroid.lat.y,
                     color = consumption_live_t/consumption_live_magnitude),
                 size = 1.2,
                 alpha = 0.75,
                 curvature = -0.35, arrow = arrow(length = unit(3, "mm"), angle = 20)) +
      scale_colour_gradient(low = "#F7AF75", high = "#E24027", limits = c(arrows_min, arrows_max))

marine_aqua_map

marine_aqua_stacked_bar <- marine_aqua_sciname %>%
  mutate(common_name = gsub(" ", "\n", common_name))%>%
  mutate(common_name = reorder(common_name, desc(total))) %>%
  ggplot(aes(x = consumption_live_t/consumption_live_magnitude, y = flow, fill = region)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7) +
  scale_fill_manual(values = region6_palette) +
  labs(x = "", y = "") +
  lims(x = c(stacked_bar_min, stacked_bar_max)) +
  facet_grid(vars(common_name), switch = "y") +
  theme_minimal() +
  theme(
    strip.text.y.left = element_text(size = 8),
    strip.placement = "right",
    legend.position = "none",
    panel.spacing = unit(0.5, "mm"),
    axis.ticks.x = element_blank(),
    axis.text.x = element_blank(),
    plot.margin = unit(c(0, 5, -5, -10), "mm")
  )

marine_aqua_stacked_bar

marine_aqua <- ggarrange(
  marine_aqua_map, marine_aqua_stacked_bar,
  nrow = 1, ncol = 2,
  widths = c(1.5, 1)
)

marine_aqua <- annotate_figure(
  marine_aqua, top = text_grob("Marine Aquaculture")#, vjust = 1),
)

marine_aqua
```

```{r inland_cap_foreign_consumption}

inland_cap_map <- trade_map +
  geom_sf(data = consumer_map_df %>%
            filter(habitat_method == "Inland Capture"), 
          aes(fill = consumption_live_t/consumption_live_magnitude, geometry = geometry), color = "white", size = 0.1) +
  scale_fill_gradient(low = "#86ADA7", high = "#0F2D59", limits = c(map_min, map_max)) +
  theme_bw() + 
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank(),
    panel.spacing = unit(2, "mm"),
    panel.border = element_blank(),
    plot.background = element_blank(),
    plot.margin = unit(c(0,0,-5,-10),"mm")
  )

inland_cap_arrows <- inland_cap_foreign_consumption %>%
  slice_max(n = 10, order_by = consumption_live_t) %>%
  # Join with lat/long data for centroids
  left_join(country_centroids, by = c("source_country_iso3c" = "iso3")) %>%
  left_join(country_centroids, by = c("consumer_iso3c" = "iso3")) %>%
  mutate(centroid.lat.x = 1.05 * centroid.lat.x,
         centroid.lat.y = 0.95 * centroid.lat.y)

inland_cap_map <- inland_cap_map +
  geom_curve(data = inland_cap_arrows, 
                 aes(x = centroid.lon.x, y = centroid.lat.x, 
                     xend = centroid.lon.y, yend = centroid.lat.y,
                     color = consumption_live_t/consumption_live_magnitude),
                 size = 1.2,
                 alpha = 0.75,
                 curvature = -0.35, arrow = arrow(length = unit(3, "mm"), angle = 20)) +
      scale_colour_gradient(low = "#F7AF75", high = "#E24027", limits = c(arrows_min, arrows_max))

inland_cap_map

inland_cap_stacked_bar <- inland_cap_sciname %>%
  mutate(common_name = gsub(" nei", "", common_name)) %>%
  mutate(common_name = case_when(
    common_name == "ray-finned fishes" ~ "ray finned fishes",
    common_name == "freshwater siluroids" ~ "\nfreshwater siluroids",
    common_name == "nile perch" ~ "\nnile perch",
    TRUE ~ common_name
  )) %>%
  mutate(common_name = gsub(" ", "\n", common_name)) %>%
  mutate(common_name = reorder(common_name, desc(total))) %>%
  ggplot(aes(x = consumption_live_t/consumption_live_magnitude, y = flow, fill = region)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7) +
  scale_fill_manual(values = region6_palette) +
  labs(x = "", y = "") +
  lims(x = c(stacked_bar_min, stacked_bar_max)) +
  facet_grid(vars(common_name), switch = "y") +
  theme_minimal() +
  theme(
    strip.text.y.left = element_text(size = 8),
    strip.placement = "outside",
    legend.position = "none",
    axis.ticks.x = element_blank(),
    axis.text.x = element_blank(),
    panel.spacing = unit(0.5, "mm"),
    plot.margin = margin(r = 5, l=-10, b=-5, unit="mm")# unit(c(, 5, 0, -10), "mm")
  )

inland_cap_stacked_bar

inland_cap <- ggarrange(
  inland_cap_map, inland_cap_stacked_bar,
  nrow = 1, ncol = 2,
  widths = c(1.5, 1)
)

inland_cap <- annotate_figure(
  inland_cap, top = text_grob("Inland Capture")#, vjust = 1),
)

inland_cap

# ggsave(file.path(outdir, "test.png"), width = 6, height = 3, dpi = 300, units = "in", device = "png")
```

```{r inland_aqua_foreign_consumption}
inland_aqua_map <- trade_map +
  geom_sf(data = consumer_map_df %>%
            filter(habitat_method == "Inland Aquaculture"), 
          aes(fill = consumption_live_t/consumption_live_magnitude, geometry = geometry), color = "white", size = 0.1) +
  scale_fill_gradient(low = "#86ADA7", high = "#0F2D59", limits = c(map_min, map_max)) +
  theme_bw() + 
  theme(
    legend.position = c(0.5, 0.05),
    legend.direction = "horizontal",
    legend.box = "vertical",
    legend.spacing.y = unit(1, "mm"),
    legend.spacing.x = unit(5, "mm"),
    legend.title = element_text(size = 10),
    legend.box.margin = margin(b = 3, t = 10, r = 20, unit = "mm"),
    legend.margin = margin(t = 0, unit = "mm"),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank(),
    panel.spacing = unit(2, "mm"),
    panel.border = element_blank(),
    plot.background = element_blank(),
    legend.key.height = unit(2.5, "mm"),
    plot.margin = margin(t=-10, unit="mm")
  )

inland_aqua_arrows <- inland_aqua_foreign_consumption %>%
  slice_max(n = 10, order_by = consumption_live_t) %>%
  # Join with lat/long data for centroids
  left_join(country_centroids, by = c("source_country_iso3c" = "iso3")) %>%
  left_join(country_centroids, by = c("consumer_iso3c" = "iso3")) %>%
  mutate(centroid.lat.x = 1.05 * centroid.lat.x,
         centroid.lat.y = 0.95 * centroid.lat.y)

inland_aqua_map <- inland_aqua_map +
  geom_curve(data = inland_aqua_arrows, 
                 aes(x = centroid.lon.x, y = centroid.lat.x, 
                     xend = centroid.lon.y, yend = centroid.lat.y,
                     color = consumption_live_t/consumption_live_magnitude),
                 size = 1.2,
                 alpha = 0.75,
                 curvature = -0.35, arrow = arrow(length = unit(3, "mm"), angle = 20)) +
      scale_colour_gradient(low = "#F7AF75", high = "#E24027", limits = c(arrows_min, arrows_max)) +
  labs(fill = "Consumption (mil. t.)",
       colour = "Export (mil. t.)           ")

inland_aqua_map

inland_aqua_stacked_bar <- inland_aqua_sciname %>%
  mutate(common_name = gsub(" nei", "", common_name)) %>%
  mutate(common_name = case_when(
    common_name == "ray-finned fishes" ~ "ray finned fishes",
    common_name == "striped catfish" ~ "\nstriped catfish",
    common_name == "freshwater siluroids" ~ "\nfreshwater siluroids",
    common_name == "nile tilapia" ~ "\nnile tilapia",
    TRUE ~ common_name
  )) %>%
  mutate(common_name = gsub(" ", "\n", common_name)) %>%
  mutate(common_name = reorder(common_name, desc(total))) %>%
  mutate(region = case_when(
    region == "North America" ~ "N. America",
    region == "South America" ~ "S. America",
    TRUE ~ region
  )) %>%
  ggplot(aes(x = consumption_live_t/consumption_live_magnitude, y = flow, fill = region)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7) +
  scale_fill_manual(values = region6_palette) +
  labs(x = "", y = "", fill = "") +
  lims(x = c(stacked_bar_min, stacked_bar_max)) +
  facet_grid(vars(common_name), switch = "y") +
  theme_minimal() +
  theme(
    strip.placement = "outside",
    strip.text.y.left = element_text(size = 8),
    legend.position = "bottom",
    legend.box = "horizontal",
    legend.text = element_text(size = 8),
    legend.key.size = unit(3, "mm"),
    legend.box.margin = margin(l = -25, unit = "mm"),
    legend.margin = margin(t = -7, b = 0, unit = "mm"),
    panel.spacing = unit(0.5, "mm"),
    plot.margin = unit(c(0, 5, 0, -10), "mm")
  )

inland_aqua_stacked_bar

inland_aqua <- ggarrange(
  inland_aqua_map, inland_aqua_stacked_bar,
  nrow = 1, ncol = 2,
  widths = c(1.5, 1))

inland_aqua <- annotate_figure(
  inland_aqua, top = text_grob("Inland Aquaculture")
)

inland_aqua

# ggsave(file.path(outdir, "test.png"), width = 6, height = 3, dpi = 300, units = "in", device = "png")
```

```{r foreign_consumption, fig.height = 15, fig.width = 8}
ggarrange(marine_cap,
          marine_aqua,
          inland_cap,
          inland_aqua,
          ncol = 1,
          heights = c(1, 1, 1, 1.1),
          common.legend = TRUE)

# ggsave(file.path(outdir, "fig2.png"), width = 9, height = 13, dpi = 500, unit = "in", device = "png")
ggsave(file.path(outdir, "fig2.pdf"), width = 180, height = 295, unit = "mm", device = "pdf")
```


# Figure 3: Trade patterns

```{r fig3_data}
artis_region_method <- read.csv(file.path(datadir, "fig_3_data.csv"))
```

```{r fig3a}
region_net_import <- artis_region_method %>% 
  group_by(year, importer_region) %>%
  summarise(import_live_weight_t = sum(live_weight_t, na.rm = TRUE)) %>%
  rename(region = importer_region) %>%
  left_join(artis_region_method %>% 
              group_by(year, exporter_region) %>%
              summarise(export_live_weight_t = sum(live_weight_t, na.rm = TRUE)) %>%
              rename(region = exporter_region), by = c("year", "region")) %>%
  mutate(net_import = import_live_weight_t-export_live_weight_t)
  
fig3a <- ggplot() +
  geom_area(data = artis_region_method %>% 
                mutate(habitat_method = factor(habitat_method, 
                                 levels = c("marine capture", "inland capture", 
                                            "marine aquaculture", "inland aquaculture", "unknown"))) %>%
              select(-exporter_importer) %>%
              pivot_longer(exporter_region:importer_region, 
                           names_to = c("flow", "drop"), 
                           values_to = "region", names_sep = "_") %>% 
              filter(flow == "exporter") %>%
              group_by(year, region, habitat_method) %>%
              summarise(live_weight_t = sum(live_weight_t, na.rm = TRUE)), 
            aes(x = year, y = -1*live_weight_t/1000000, fill = habitat_method)) +
  geom_area(data = artis_region_method %>% 
                mutate(habitat_method = factor(habitat_method, 
                                 levels = c("marine capture", "inland capture", 
                                            "marine aquaculture", "inland aquaculture", "unknown"))) %>%
              select(-exporter_importer) %>%
              pivot_longer(exporter_region:importer_region, 
                           names_to = c("flow", "drop"), 
                           values_to = "region", names_sep = "_") %>% 
              filter(flow == "importer") %>%
              group_by(year, region, habitat_method) %>%
              summarise(live_weight_t = sum(live_weight_t, na.rm = TRUE)), 
            aes(x = year, y = live_weight_t/1000000, fill = habitat_method)) +
  scale_fill_manual(values = habitat_source_colors) +
  geom_hline(yintercept = 0, color = "black", linewidth = 0.5, linetype = "dashed") +
  geom_line(data = region_net_import, aes(x = year, y = net_import/1000000, color = "Net import"), linewidth = 1) +
  scale_color_manual(values = "black") +
  labs(x = "", y = "Trade (million t, live weight)", fill = "Source", color = "") +
  guides(fill = guide_legend(nrow = 2)) +
  theme_bw() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        strip.background = element_blank(),
        plot.margin = unit(c(t=0, r=1, b=0, l=0.5), "cm")) +
  facet_wrap(~region, nrow = 1)

fig3a <- ggdraw(fig3a) +
  draw_label("Net import", x = 0.97, y = 0.55, angle = 270, size = 9) +
  draw_label("Net export", x = 0.97, y = 0.3, angle = 270, size = 9)

fig3a
```


```{r fig3b}
# Matrix of plots showcasing inter-regional trade trends
fig3b <- artis_region_method %>% 
    mutate(habitat_method = factor(habitat_method, 
                                 levels = c("marine capture", "inland capture", 
                                            "marine aquaculture", "inland aquaculture", "unknown"))) %>%
  ggplot(aes(x = year, y = live_weight_t/1000000, fill = habitat_method)) +
  geom_area() +
  scale_fill_manual(values = habitat_source_colors) +
  scale_y_continuous(position = "right") +
  labs(x = "", y = "", color = "Ave. annual change in export \n(1000 t live weight)",
       fill = "Source") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position = "none",
        strip.background = element_blank(),
        plot.margin = margin(t = 6, r = 7, l = 6, unit = "mm")) +
  facet_grid(rows = vars(exporter_region), cols = vars(importer_region), 
             labeller = label_wrap_gen(width = 5), scales = "free", switch = "y")

fig3b <- ggdraw(fig3b) +
  draw_label("Exporting region", x = 0.02, y = 0.5, angle = 90, size = 10) +
  draw_label("Importing region", x = 0.5, y = 0.965, size = 10) +
  draw_label("Trade (million t, live weight)", x = 0.96, y = 0.5, angle = 270, size = 10)

fig3b
```

```{r fig3, fig.height=8, fig.width=6.5}
# Overall Figure 3
ggarrange(ggarrange(fig3a, NULL,
                    ncol = 2, nrow = 1,
                    widths = c(4.5, 0.2), labels = c("a", "")), 
          fig3b, labels = c("", "b"),
          ncol = 1, heights = c(3, 4))

# ggsave(file.path(outdir, "fig3.png"))
ggsave(file.path(outdir, "fig3.pdf"), height = 210, width = 180, unit = "mm", device = "pdf")
```


# Figure 3: Foreign consumption maps and top species traded



# Figure 4
```{r fig4a}
# Global per capita supply
fig4a_data <- read.csv(file.path(datadir, "fig_4a_data.csv"))

fig4a <- fig4a_data %>%
  # Set factor levels
  mutate(habitat_method = factor(habitat_method, levels = c("marine capture", "inland capture",
                                                            "marine aquaculture", "inland aquaculture",
                                                            "unknown" ))) %>%
  ggplot(aes(x = year, y = supply_per_cap, color = habitat_method)) +
  geom_line() + 
  labs(y = "Per capita supply (kg)", x = "", color = "Source") +
  scale_color_manual(values = habitat_source_colors) +
  guides(color = guide_legend(nrow = 1)) +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

fig4a
```

```{r fig4b}
# Per capita supply by region
fig4b_data <- read.csv(file.path(datadir, "fig_4b_data.csv"))

fig4b <- fig4b_data %>%
   # Set factor levels
  mutate(habitat_method = factor(habitat_method, levels = c("marine capture", "inland capture",
                                                            "marine aquaculture", "inland aquaculture",
                                                            "unknown" ))) %>%
  ggplot(aes(x = year, y = supply_per_cap, fill = habitat_method)) +
  geom_area() + 
  labs(y = "Per capita supply (kg)", x = "", fill = "Source") +
  scale_fill_manual(values = habitat_source_colors) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        strip.background = element_blank()) +
  facet_wrap(~region)

fig4b
```

```{r fig4c}
# Global percent of supply by domestic / foreign exports
fig4c_data <- read.csv(file.path(datadir, "fig_4c_data.csv"))

fig4c <- ggplot() +
  geom_line(data = fig4c_data, aes(x = year, y = supply_percent, color = supply_source)) +
  scale_color_manual(values = c("#F37542", "#0F2D59")) +
  labs(x = "", y = "Percent of supply", color = "Origin") +
  lims(y = c(0,100)) +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

fig4c
```

```{r fig4d}
fig4d_data <- read.csv(file.path(datadir, "fig_4d_data.csv"))

fig4d <- fig4d_data %>%
  ggplot(aes(x = year, y = supply_percent, color = supply_source)) +
  geom_line() +
  scale_color_manual(values = c("#F37542", "#0F2D59")) +
  labs(x = "", y = "Percent of supply", color = "Origin") +
  facet_wrap(~region) +
  lims(y = c(0,100)) +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        strip.background = element_blank())

fig4d
```

```{r fig4, fig.height = 6, fig.width = 7}
fig4 <- ggarrange(
  ggarrange(fig4a, fig4b, 
            common.legend = TRUE, nrow = 1, widths = c(1, 2),
            labels = c("a", "b")),
  ggarrange(fig4c, fig4d,
            common.legend = TRUE, nrow = 1, widths = c(1, 2),
            labels = c("c", "d")),
  nrow = 2
)

fig4

# ggsave(file.path(outdir, "fig4.png"))
ggsave(file.path(outdir, "fig4.pdf"), height = 180, width = 180, unit = "mm", device = "pdf")
```


# Supplementary Figures

```{r regional_sankey, fig.height = 3, fig.width = 3}
regional_artis <- read.csv(file.path(datadir, "si_fig_1_data.csv")) %>%
  mutate(exporter_region = case_when(
    exporter_region == "North America" ~ "N.America",
    exporter_region == "South America" ~ "S.America",
    TRUE ~ exporter_region
  )) %>%
  mutate(importer_region = case_when(
    importer_region == "North America" ~ "N.America",
    importer_region == "South America" ~ "S.America",
    TRUE ~ importer_region
  ))

marine_cap_regions <- regional_artis %>%
  filter(habitat == "marine" & method == "capture") %>%
  group_by(exporter_region, importer_region) %>%
    summarize(live_weight_t = sum(live_weight_t, na.rm = TRUE)) %>%
    ungroup() %>%
    make_long(exporter_region, importer_region, value = live_weight_t)

marine_cap_regions$node <- factor(marine_cap_regions$node,
                              levels = c("Europe", "Oceania", "Asia",
                                         "S.America", "N.America",
                                         "Africa"))

marine_cap_p <- marine_cap_regions %>%
  ggplot(aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node),
               value = value,
               label = node)) +
    geom_sankey(flow.alpha = 0.6) +
    scale_fill_manual(values = region_colors) +
    geom_sankey_label(size = 4, color = "white", fill = "gray40") +
    theme_sankey(base_size = 18) +
  labs(x = NULL) +
    #labs(title = "Marine", x = NULL, y = "CAPTURE") +
  theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    plot.title = element_text(hjust = 0.5),
    plot.margin = margin(c(t=-0.5, r=-7, b=-1, l=-25), unit = "mm")
    )

marine_cap_p <- ggdraw(marine_cap_p) +
  draw_label("Marine capture", x = 0.5, y = 0.97, size = 9)

marine_cap_p
```

```{r marine_aqua, fig.height = 3, fig.width = 3}
marine_aqua_regions <- regional_artis %>%
  filter(habitat == "marine" & method == "aquaculture") %>%
  group_by(exporter_region, importer_region) %>%
    summarize(live_weight_t = sum(live_weight_t, na.rm = TRUE)) %>%
    ungroup() %>%
    make_long(exporter_region, importer_region, value = live_weight_t)

marine_aqua_regions$node <- factor(marine_aqua_regions$node,
                              levels = c("Europe", "Oceania", "Asia",
                                         "S.America", "N.America",
                                         "Africa"))

marine_aqua_p <- marine_aqua_regions %>%
  ggplot(aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node),
               value = value,
               label = node)) +
    geom_sankey(flow.alpha = 0.6) +
    scale_fill_manual(values = region_colors) +
    geom_sankey_label(size = 4, color = "white", fill = "gray40") +
    theme_sankey(base_size = 18) +
  labs(x = NULL) +
    #labs(title = "Marine", x = NULL, y = "CAPTURE") +
  theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    plot.title = element_text(hjust = 0.5),
    plot.margin = margin(c(t=-0.5, r=-7, b=-1, l=-25), unit = "mm")
    )

marine_aqua_p <- ggdraw(marine_aqua_p) +
  draw_label("Marine aquaculture", x = 0.5, y = 0.97, size = 9)

marine_aqua_p
```

```{r inland_cap, fig.height = 3, fig.width = 3}
inland_cap_regions <- regional_artis %>%
  filter(habitat == "inland" & method == "capture") %>%
  group_by(exporter_region, importer_region) %>%
    summarize(live_weight_t = sum(live_weight_t, na.rm = TRUE)) %>%
    ungroup() %>%
    make_long(exporter_region, importer_region, value = live_weight_t)

inland_cap_regions$node <- factor(inland_cap_regions$node,
                              levels = c("Europe", "Oceania", "Asia",
                                         "S.America", "N.America",
                                         "Africa"))

inland_cap_p <- inland_cap_regions %>%
  ggplot(aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node),
               value = value,
               label = node)) +
    geom_sankey(flow.alpha = 0.6) +
    scale_fill_manual(values = region_colors) +
    geom_sankey_label(size = 4, color = "white", fill = "gray40") +
    theme_sankey(base_size = 18) +
  labs(x = NULL) +
    #labs(title = "Marine", x = NULL, y = "CAPTURE") +
  theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    plot.title = element_text(hjust = 0.5),
    plot.margin = margin(c(t=-0.5, r=-18, b=-1, l=-18), unit = "mm")
    )

inland_cap_p <- ggdraw(inland_cap_p) +
  draw_label("Inland capture", x = 0.5, y = 0.97, size = 9)

inland_cap_p
```

```{r inland_aqua, fig.height = 3, fig.width = 3}
inland_aqua_regions <- regional_artis %>%
  filter(habitat == "inland" & method == "aquaculture") %>%
  group_by(exporter_region, importer_region) %>%
    summarize(live_weight_t = sum(live_weight_t, na.rm = TRUE)) %>%
    ungroup() %>%
    make_long(exporter_region, importer_region, value = live_weight_t)

inland_aqua_regions$node <- factor(inland_aqua_regions$node,
                              levels = c("Europe", "Oceania", "Asia",
                                         "S.America", "N.America",
                                         "Africa"))

inland_aqua_p <- inland_aqua_regions %>%
  ggplot(aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node),
               value = value,
               label = node)) +
    geom_sankey(flow.alpha = 0.6) +
    scale_fill_manual(values = region_colors) +
    geom_sankey_label(size = 4, color = "white", fill = "gray40") +
    theme_sankey(base_size = 18) +
  labs(x = NULL, title = NULL) +
  theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 9),
    plot.margin = margin(c(t=-0.5, r=-18, b=-1, l=-18), unit = "mm")
    )

inland_aqua_p <- ggdraw(inland_aqua_p) +
  draw_label("Inland aquaculture", x = 0.5, y = 0.97, size = 9)

inland_aqua_p
```
```{r regional_sankey_by_source, fig.height = 8, fig.width = 10}
ggarrange(marine_cap_p, inland_cap_p,
            marine_aqua_p, inland_aqua_p,
            ncol = 2, nrow = 2,
          labels = c("a", "b", "c", "d"))

# ggsave(file.path(outdir, "si_fig1.png"))
ggsave(file.path(outdir, "si_fig1.pdf"), height = 200, width = 180, unit = "mm", device = "pdf")
```

```{r si_fig_2_top_exporters, fig.height = 7, fig.width = 6}

top_exporters_old <- read.csv(file.path(datadir, "si_fig_2_exporters_old.csv")) %>%
  mutate(habitat_method = factor(habitat_method, 
                                 levels = c("marine capture", "inland capture", 
                                            "marine aquaculture", "inland aquaculture", "unknown")))
top_exporters_recent <- read.csv(file.path(datadir, "si_fig_2_exporters_recent.csv")) %>%
  mutate(habitat_method = factor(habitat_method, 
                                 levels = c("marine capture", "inland capture", 
                                            "marine aquaculture", "inland aquaculture", "unknown")))

exporters_old_plot <- top_exporters_old %>%
  pivot_longer(cols = c("domestic", "foreign"), names_to = "dom_source", values_to = "live_weight_t_2") %>%
  ggplot(aes(x = live_weight_t_2/1000000, y = reorder(exporter_iso3c, ranking), fill = dom_source)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = habitat_source_colors) +
  scale_y_reordered() +
  labs(y = "", x = "Live weight (million t)", fill = "Export Source") +
  xlim(c(0,6)) +
  facet_wrap(~habitat_method, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 8)
  )

exporters_recent_plot <- top_exporters_recent %>%
  pivot_longer(cols = c("domestic", "foreign"), names_to = "dom_source", values_to = "live_weight_t_2") %>%
  ggplot(aes(x = live_weight_t_2/1000000, y = reorder(exporter_iso3c, ranking), fill = dom_source)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = habitat_source_colors) +
  scale_y_reordered() +
  labs(y = "", x = "Live weight (million t)", fill = "Export Source") +
  facet_wrap(~habitat_method, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 8)
  )


ggarrange(
  exporters_old_plot,
  exporters_recent_plot,
  ncol = 2,
  labels = c("'96-'00", "'16-'20"),
  common.legend = TRUE
)

# ggsave(file.path(outdir, "si_fig2.png"))
ggsave(file.path(outdir, "si_fig2.pdf"), height = 200, width = 180, units = "mm", device = "pdf")
```


```{r si_fig3_top_importers, fig.height = 7, fig.width = 6}

top_importers_old <- read.csv(file.path(datadir, "si_fig_3_importers_old.csv")) %>%
  mutate(habitat_method = factor(habitat_method, 
                                 levels = c("marine capture", "inland capture", 
                                            "marine aquaculture", "inland aquaculture", "unknown")))
top_importers_recent <- read.csv(file.path(datadir, "si_fig_3_importers_recent.csv")) %>%
  mutate(habitat_method = factor(habitat_method, 
                                 levels = c("marine capture", "inland capture", 
                                            "marine aquaculture", "inland aquaculture", "unknown")))

importers_old_plot <- top_importers_old %>%
  pivot_longer(cols = c("domestic", "foreign"), names_to = "dom_source", values_to = "live_weight_t_2") %>%
  ggplot(aes(x = live_weight_t_2/1000000, y = reorder(importer_iso3c, ranking), fill = dom_source)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = habitat_source_colors) +
  scale_y_reordered() +
  xlim(c(0, 5.5)) +
  labs(y = "", x = "Live weight (million t)", fill = "Import Source") +
  facet_wrap(~habitat_method, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 8)
  )

importers_recent_plot <- top_importers_recent %>%
  pivot_longer(cols = c("domestic", "foreign"), names_to = "dom_source", values_to = "live_weight_t_2") %>%
  ggplot(aes(x = live_weight_t_2/1000000, y = reorder(importer_iso3c, ranking), fill = dom_source)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = habitat_source_colors) +
  scale_y_reordered() +
  xlim(c(0, 5.5)) +
  labs(y = "", x = "Live weight (million t)", fill = "Import Source") +
  facet_wrap(~habitat_method, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 8)
  )

ggarrange(
  importers_old_plot,
  importers_recent_plot,
  ncol = 2,
  labels = c("'96-'00", "'16-'20"),
  common.legend = TRUE
)

# ggsave(file.path(outdir, "si_fig3.png"))
ggsave(file.path(outdir, "si_fig3.pdf"), height = 200, width = 180, units = "mm", device = "pdf")
```

```{r si_fig4_regional_avg_annual_change, fig.height = 8, fig.width = 7}
regional_avg_annual_change <- read.csv(file.path(datadir, "si_fig_4_data.csv"))

regional_slopes_ranked <- regional_avg_annual_change %>%
  ggplot(aes(x = slope/1000, y = reorder(exporter_importer, slope), color = intraregion)) +
  geom_segment(aes(x=0, xend=slope/1000, y=reorder(exporter_importer, slope), yend=exporter_importer, color = intraregion)) +
  geom_point(size=3) +
  scale_y_reordered() +
  scale_color_manual(values = habitat_source_colors[c(1,4)]) +
  labs(y = "", x = "Ave. annual change in export (1000 t live weight)", color = "") +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text = element_text(size = 8)
  )

regional_slopes_ranked

# ggsave(file.path(outdir, "si_fig4.png"))
ggsave(file.path(outdir, "si_fig4.pdf"), height = 200, width = 180, unit = "mm", device = "pdf")
```

```{r si_fig5a, fig.height = 4, fig.width = 6}
dom_source_ts <- read.csv(file.path(datadir, "si_fig_5a_data.csv"))

dom_source_ts_p <- dom_source_ts %>%
  ggplot(aes(x = year, y = live_weight_t / 1000000, color = dom_source)) +
  geom_line() +
  scale_color_manual(values = c("#D38F35", "grey40", "#114F59")) +
  theme_bw() +
  labs(x = "", y = "Live weight\nmillion tonnes", color = "Source") +
  theme(
    legend.position = "bottom",
    axis.text = element_text(size = 10),
    legend.box.margin=margin(t = -25)
  )

dom_source_ts_p
```

```{r si_fig5b, fig.height = 4, fig.width = 7}
dom_source_by_habitat_method <- read.csv(file.path(datadir, "si_fig_5b_data.csv"))

dom_source_by_habitat_method_p <- dom_source_by_habitat_method %>%
  mutate(habitat_method = gsub(" ", "\n", habitat_method)) %>%
  # Set factor levels
  mutate(habitat_method = factor(habitat_method, levels = c("marine\ncapture", "inland\ncapture",
                                                            "marine\naquaculture", "inland\naquaculture",
                                                            "unknown" ))) %>%
  ggplot(aes(x = year, y = live_weight_t / 1000000, fill = habitat_method)) +
  geom_area() +
  scale_fill_manual(values = habitat_source_colors) +
  theme_bw() +
  labs(x = "", y = "Live weight\nmillion tonnes", fill = "Source") +
  facet_wrap(~dom_source) +
  theme(
    legend.position = "bottom",
    axis.text = element_text(size = 10),
    panel.spacing = unit(5, "mm"),
    legend.box.margin=margin(t = -15)
  )

 dom_source_by_habitat_method_p
```

```{r si_fig5, fig.height = 5, fig.width = 8}
 ggarrange(
   dom_source_ts_p,
   dom_source_by_habitat_method_p,
   nrow = 2,
   labels = c("a", "b")
)

# ggsave(file.path(outdir, "si_fig5.png"))
ggsave(file.path(outdir, "si_fig5.pdf"), height = 125, width = 180, unit = "mm", device = "pdf")
```


```{r si_fig6_ldc_net_exports_habitat_method, fig.height = 4, fig.width = 7}
ldc_net_habitat_method_summary <- read.csv(file.path(datadir, "si_fig_6_data.csv")) %>%
  select(year, habitat_method, net_export)

ldc_net_total <- ldc_net_habitat_method_summary %>%
  group_by(year) %>%
  summarise(net_export = sum(net_export)) %>%
  mutate(habitat_method = "total")

ldc_net_habitat_method_summary <- ldc_net_habitat_method_summary %>%
  bind_rows(ldc_net_total) %>%
  mutate(habitat_method = factor(habitat_method, 
                                 levels = c("marine capture", "inland capture", 
                                            "marine aquaculture", "inland aquaculture", "total")))

ldc_net_exports_by_source_plot <- ldc_net_habitat_method_summary %>%
  ggplot(aes(x = year, y = net_export/1000000, color = habitat_method)) +
  geom_line(size = 1) +
  scale_color_manual(values = habitat_source_colors) +
  labs(x = "", y = "Net export (million t)", color = "") +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text = element_text(size = 12)
  )

ldc_net_exports_by_source_plot

# ggsave(file.path(outdir, "si_fig6.png"))
ggsave(file.path(outdir, "si_fig6.pdf"), height = 80, width = 180, unit = "mm", device = "pdf")
```


```{r si_fig7_custom_artis_ts, fig.height = 4, fig.width = 6}
artis_ts <- read.csv(file.path(datadir, "si_fig_7_artis_ts.csv")) %>%
  mutate(hs_version = factor(hs_version,
                             levels = c("HS96", "HS02", "HS07", "HS12", "HS17")))
custom_ts <- read.csv(file.path(datadir, "si_fig_7_custom_ts.csv"))

ggplot() +
  geom_line(data = artis_ts, aes(x = year, y = product_weight_t/1e6, color = hs_version), linetype = "dashed", linewidth = 1) +
  geom_line(data = custom_ts, aes(x = year, y = product_weight_t/1e6, color = hs_version), linewidth = 0.5, linetype = "solid") +
  scale_color_manual(
    values = c("Custom ARTIS Time series" = "black", "HS96" = "#741A32", "HS02" = "#B34232", "HS07" = "#D38F35", "HS12" = "red", "HS17" = "#114F59")
  ) +
  labs(x = "Year", y = "Product Weight (million tonnes)", color = "HS Version") +
  theme_bw() +
  theme(
    legend.position = "bottom",
    axis.text = element_text(size = 10)
  )

# ggsave(file.path(outdir, "si_fig7.png"))
ggsave(file.path(outdir, "si_fig7.pdf"), height = 80, width = 180, unit = "mm", device = "pdf")
```

