---
title: "ms_figures"
author: "Jessica Gephart"
date: "2022-08-15"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(countrycode)
library(circlize)
library(here)
library(ggpubr)
library(kableExtra)
library(DBI)
library(janitor)
library(viridis)
library(broom)
library(exploreARTIS)
library(vegan)
library(tidytext)
```

```{r load_data}
# Set directories
datadir <- "/Volumes/jgephart/ARTIS/Outputs/ms_seafood_globalization/20220111"
outdir <- "/Volumes/jgephart/ARTIS/Outputs/ms_seafood_globalization/outputs_20220111"


```

```{r color_palettes}
# Set color palettes
# All colors from palette: #FFE6BE (light yellow), #F7AF75 (light orange), #F37542 (medium orange), 
# #E24027 (dark orange), #0F2D59 (navy), #1B708F (blue), #2E8D9A (teal), #86ADA7 (light blue)
method_colors <- c("#F7AF75", "#2E8D9A", "#86ADA7") # light orange, teal, light blue
source_colors <- c("#F37542", "#0F2D59", "#86ADA7") # medium orange, navy, light blue
environment_colors <- c( "#2E8D9A", "#0F2D59","#86ADA7") # teal, navy, light blue

habitat_source_colors <- c("#1B708F", # blue = marine capture
                          "#86ADA7", # light blue = freshwater capture
                          "#F37542", # medium orange = marine aquaculture
                          "#F7AF75", # light orange = inland aquaculture
                          "grey50" # unknown
                          )

region_colors <- c(
  "#741A32", # maroon
  "#B34232", # burnt orange
  "#D38F35", #  orange
  "#D4B95f", # khaki
  "#4FA2A2", # teal
  "#114F59" # dark teal
)

```

```{r load_drive_data}

pop <- read.csv("/Volumes/jgephart/ARTIS/Outputs/clean_metadata/fao_annual_pop.csv") %>% 
  left_join(country_metadata, by = c("iso3c")) %>%
  select(iso3c, year, "region" = "owid_region", pop)

```

# Figure 1: Increases in global export of blue foods

## Figure 1 a: Exports of global marine and freshwater aquaculture and fishery products (t live weight equivalent) from 1996-2019

```{r fig1a}
fig1a_data <- read.csv(file.path(datadir, "fig_1a_data.csv"))

fig1a <- fig1a_data %>%
  ggplot(aes(x = year, y = live_weight_t/1000000, fill = habitat_method)) +
  geom_area() +
  scale_fill_manual(values = habitat_source_colors) +
  labs(y = "Exports (mil. t, live weight)", fill = "Source", x = "") +
  theme_bw() +
  theme(legend.position = "bottom")

fig1a
```


## Figure 1 b: Percent of global marine and freshwater aquaculture and fishery production exported, excluding re-exports

```{r fig1b}
fig1b_data <- read.csv(file.path(datadir, "fig_1b_data.csv"))

fig1b <- ggplot() +
  geom_line(data = percent_export_by_source, aes(x = year, y = percent_export, color = habitat_method)) +
  scale_color_manual(values = habitat_source_colors) +
  labs(y = "% Production Exported", x = "", color = "Source") +
  theme_bw()

fig1b
```


## Figure 1 c: Degree or measure of degree distribution by production method and environment

```{r fig1c}
fig1c_data <- read.csv(file.path(datadir, "fig_1c_data.csv"))

fig1c_out_degree <- fig1c_data %>%
  ggplot(aes(x = year, y = all_in_degree, color = habitat_method)) +
  geom_smooth() +
  scale_color_manual(values = habitat_source_colors) +
  labs(y = "Out degree", color = "Source") + 
  theme_bw()

fig1c_out_degree
```

```{r fig1, fig.height = 3, fig.width = 4.5}
ggarrange(fig1a,
          ggarrange(fig1b,
                    fig1c_out_degree,
                    ncol = 2, nrow = 1,
                    legend = "none",
                    labels = c("b", "c")),
          common.legend = TRUE, legend = "bottom",
          ncol = 1, nrow = 2, labels = c("a", ""))

ggsave(file.path(outdir, "fig1.png"))
```


# Figure 2: Trade patterns

```{r fig2_data}
artis_region_method <- read.csv(file.path(datadir, "artis_region_method.csv"))
artis_region <- read.csv(file.path(datadir, "artis_region.csv"))
```

```{r fig2a}
# Imports by Region
fig2a <- artis_region %>% 
  ggplot(aes(x = year, y = live_weight_t/1000000, fill = exporter_region)) +
  geom_area() +
  labs(x = "", y = "", fill = "Exporter") +
  scale_fill_manual(values = region_colors) +
  facet_wrap(~importer_region, nrow = 1) +
  theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.text.x = element_blank(),
        plot.margin=unit(c(0.5,0,0,0), "cm"))

fig2a
```

```{r fig2b}
# Matrix of plots showcasing inter-regional trade trends
fig2b <- artis_region_method %>% 
  ggplot(aes(x = year, y = live_weight_t/1000000, fill = habitat_method)) +
  geom_area() +
  scale_fill_manual(values = habitat_source_colors) +
  labs(x = "", y = "Trade (million t, live weight)", color = "Ave. annual change in export \n(1000 t live weight)") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        legend.position = "none",
        strip.background = element_blank(),
        plot.margin=unit(c(0,0,0,0), "cm")) +
  facet_grid(rows = vars(exporter_region), cols = vars(importer_region), 
             labeller = label_wrap_gen(width = 5), scales = "free")

fig2b
```

```{r fig 2c}
# Figure 2c
# Exports by Region
fig2c <- artis_region %>% 
  ggplot(aes(x = year, y = live_weight_t/1000000, fill = importer_region)) +
  geom_area() +
  labs(x = "", y = "", fill = "Importer") +
  scale_fill_manual(values = region_colors) +
  facet_wrap(~exporter_region, ncol = 1) +
  theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.margin=unit(c(0,0.5,0,0), "cm"))

fig2c
```

```{r fig2}
# Overall Figure 2
ggarrange(ggarrange(fig2a, NULL,
                    ncol = 2, nrow = 1,
                    widths = c(4.5, 1.25), labels = c("a", "")),
          ggarrange(fig2b, 
                    ggarrange(NULL, fig2c,
                              ncol = 1, heights = c(0.3, 4)), 
                    ncol = 2, nrow = 1,
                    widths = c(4.5, 1), labels = c("b", "c")),
          ncol = 1, nrow = 2, 
          heights = c(1, 4.5))

ggsave(file.path(outdir, "fig2.png"))
```

# Figure 3
```{r fig3a}
# Global per capita supply
fig3a_data <- read.csv(file.path(datadir, "fig3a_data.csv"))

fig3a <- fig3a_data %>%
  ggplot(aes(x = year, y = supply_per_cap, color = habitat_method)) +
  geom_line() + 
  labs(y = "Per capita supply (kg)", x = "", color = "Source") +
  scale_color_manual(values = habitat_source_colors) +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

fig3a
```

```{r fig3b}
# Per capita supply by region
fig3b_data <- read.csv(file.path(datadir, "fig3b_data.csv"))

fig3b <- fig3b_data %>%
  ggplot(aes(x = year, y = supply_per_cap, fill = habitat_method)) +
  geom_area() + 
  labs(y = "Per capita supply (kg)", x = "", fill = "Source") +
  scale_fill_manual(values = habitat_source_colors) +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~region)

fig3b
```

```{r fig3c}
# Global percent of supply by domestic / foreign exports
fig3c_data <- read.csv(file.path(datadir, "fig3c_data.csv"))

fig3c <- fig3c_data %>%
  ggplot(aes(x = year, y = supply_percent, color = supply_source)) +
  geom_line() +
  scale_color_manual(values = c("#F37542", "#0F2D59")) +
  labs(x = "", y = "Percent of supply", color = "Origin") +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

fig3c
```

```{r fig3d}
fig3d_data <- read.csv(file.path(datadir, "fig3d_data.csv"))

fig3d <- fig3d_data %>%
  ggplot(aes(x = year, y = supply_percent, color = supply_source)) +
  geom_line() +
  scale_color_manual(values = c("#F37542", "#0F2D59")) +
  labs(x = "", y = "Percent of supply", color = "Origin") +
  facet_wrap(~region) +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

fig3d
```

```{r fig3}
fig3 <- ggarrange(
  ggarrange(fig3a, fig3b, 
            common.legend = TRUE, nrow = 1, widths = c(1, 2),
            labels = c("a", "b")),
  ggarrange(fig3c, fig3d,
            common.legend = TRUE, nrow = 1, widths = c(1, 2),
            labels = c("c", "d")),
  nrow = 2
)

fig3

ggsave(file.path(outdir, "fig3.png"))
```


```{r fig4a}
fig4a_data <- read.csv(file.path(datadir, "figa4a_data.csv"))

fig4a <- fig4a_data %>%
  ggplot(aes(x = year, y = shannon, color = source)) +
  geom_line() +
  scale_color_manual(values = c(c("#F37542", "#0F2D59"))) +
  labs(x = "", y = "Shannon index", color = "") +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~region)

fig4a
```

```{r fig4b}
fig4b_data <- read.csv(file.path(datadir, "fig4b_data.csv"))

fig4b <- fig4b_data %>%
  ggplot(aes(x = shannon_supply_domestic, y = shannon_supply_foreign, color = region)) +
    geom_point(alpha = 0.7) +
    geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = region_colors) +
  labs(x = "Domestic supply diversity", 
       y = "Foreign supply diversity",
       color = "") +
    theme_minimal()

fig4b
```

```{r fig4c}
fig4c_data <- read.csv(file.path(datadir, "fig4c_data.csv"))

fig4c <- fig4c_data %>%
  ggplot(aes(x = imports_live_weight_t/1000000, y = shannon_supply_no_error, color = region)) +
  geom_point(alpha = 0.7) +
  scale_x_log10() +
  scale_color_manual(values = region_colors) +
  theme_minimal() +
  labs(x = "Total imports (million t, live weight)",
       y = "Supply diversity",
       color = "")

fig4c
```
```{r fig4, fig.height = 3, fig.width = 3}
fig4 <- ggarrange(fig4a, 
          ggarrange(fig4b,
                    fig4c,
                    nrow = 1,
                    common.legend = TRUE, 
                    legend = "bottom",
                    labels = c("b", "c")),
          nrow = 2,
          labels = c("a", "", "")
          )

fig4
```

# Supplementary Figures

```{r si_top_exporters, fig.height = 4, fig.width = 4}

top_exporters_old <- read.csv(file.path(datadir, "top_exporters_old.csv"), row.names = FALSE)
top_exporters_recent <- read.csv(file.path(datadir, "top_exporters_recent.csv"), row.names = FALSE)

exporters_old_plot <- top_exporters_old %>%
  ggplot(aes(x = live_weight_t/1000000, y = exporter_iso3c, fill = habitat_method)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = habitat_source_colors) +
  scale_y_reordered() +
  labs(y = "", x = "Live weight (million t)") +
  facet_wrap(~habitat_method, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "none")

exporters_recent_plot <- top_exporters_recent %>%
  ggplot(aes(x = live_weight_t/1000000, y = exporter_iso3c, fill = habitat_method)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = habitat_source_colors) +
  scale_y_reordered() +
  labs(y = "", x = "Live weight (million t)") +
  facet_wrap(~habitat_method, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "none")


ggarrange(
  exporters_old_plot,
  exporters_recent_plot,
  ncol = 2,
  labels = c("Old", "Recent")
)

ggsave(file.path(outdir, "si_top_exporters.png"))
```

```{r si_top_importers, fig.height = 4, fig.width = 4}

top_importers_old <- read.csv(file.path(datadir, "top_importers_old.csv"), row.names = FALSE)
top_importers_recent <- read.csv(file.path(datadir, "top_importers_recent.csv"), row.names = FALSE)

importers_old_plot <- top_importers_old %>%
  ggplot(aes(x = live_weight_t/1000000, y = importer_iso3c, fill = habitat_method)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = habitat_source_colors) +
  scale_y_reordered() +
  labs(y = "", x = "Live weight (million t)") +
  facet_wrap(~habitat_method, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "none")

importers_recent_plot <- top_importers_recent %>%
  ggplot(aes(x = live_weight_t/1000000, y = importer_iso3c, fill = habitat_method)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = habitat_source_colors) +
  scale_y_reordered() +
  labs(y = "", x = "Live weight (million t)") +
  facet_wrap(~habitat_method, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "none")

ggarrange(
  importers_old_plot,
  importers_recent_plot,
  ncol = 2,
  labels = c("Old", "Recent")
)

ggsave(file.path(outdir, "si_top_importers.png"))
```

```{r si_regional_changes, fig.height = 4, fig.width = 4}

# Largest regional export changes
top_regional_export_change <- read.csv(file.path(datadir, "top_regional_export_change.csv"))

regional_export_change_plot <- top_regional_export_change %>%
  ggplot(aes(x = change/1000000, y = exporter_region, fill = habitat_method, color = habitat_method)) +
  geom_segment(aes(x=0, xend=change/1000000, y=exporter_region, yend=exporter_region)) +
  geom_point(size=4) +
  scale_color_manual(values = habitat_source_colors) +
  scale_y_reordered() +
  labs(y = "", x = "Live weight (million t)") +
  facet_wrap(~habitat_method, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "none")

# Largest regional import changes
top_regional_import_change <- read.csv(file.path(datadir, "top_regional_import_change.csv"))

regional_import_change_plot <- top_regional_import_change %>%
  ggplot(aes(x = change/1000000, y = importer_region, fill = habitat_method, color = habitat_method)) +
  geom_segment(aes(x=0, xend=change/1000000, y=importer_region, yend=importer_region)) +
  geom_point(size=4) +
  scale_color_manual(values = habitat_source_colors) +
  scale_y_reordered() +
  labs(y = "", x = "Live weight (million t)") +
  facet_wrap(~habitat_method, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "none")

ggarrange(
  regional_export_change_plot,
  regional_import_change_plot,
  ncol = 2,
  labels = c("Export", "Import")
)

ggsave(file.path(outdir, "regional_changes.png"))
```

```{r si_export_decreases_increases, fig.height = 4, fig.width = 4}
top_exporter_increases <- read.csv(file.path(datadir, "top_export_increases.csv"))
top_exporter_decreases <- read.csv(file.path(datadir, "top_export_decreases.csv"))

exporter_increases_plot <- top_export_increases %>%
  ggplot(aes(x = change/1000000, y = exporter_iso3c, fill = habitat_method, color = habitat_method)) +
  geom_segment(aes(x=0, xend=change/1000000, y=exporter_iso3c, yend=exporter_iso3c)) +
  geom_point(size=4) +
  scale_color_manual(values = habitat_source_colors) +
  scale_y_reordered() +
  labs(y = "", x = "Live weight (million t)") +
  facet_wrap(~habitat_method, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "none")

exporter_decreases_plot <- top_export_decreases %>%
  ggplot(aes(x = change/1000000, y = exporter_iso3c, fill = habitat_method, color = habitat_method)) +
  geom_segment(aes(x=0, xend=change/1000000, y=exporter_iso3c, yend=exporter_iso3c)) +
  geom_point(size=4) +
  scale_color_manual(values = habitat_source_colors) +
  scale_y_reordered() +
  labs(y = "", x = "Live weight (million t)") +
  facet_wrap(~habitat_method, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "none")

ggarrange(
  exporter_decreases_plot, exporter_increases_plot, nrow = 1
)

ggsave(file.path(outdir, "si_export_changes.png"))
```

```{r si_import_decreases_increases, fig.height = 4, fig.width = 4}
top_importer_increases <- read.csv(file.path(datadir, "top_import_increases.csv"))
top_importer_decreases <- read.csv(file.path(datadir, "top_import_decreases.csv"))

importer_increases_plot <- top_import_increases %>%
  ggplot(aes(x = change/1000000, y = importer_iso3c, fill = habitat_method, color = habitat_method)) +
  geom_segment(aes(x=0, xend=change/1000000, y=importer_iso3c, yend=importer_iso3c)) +
  geom_point(size=4) +
  scale_color_manual(values = habitat_source_colors) +
  scale_y_reordered() +
  labs(y = "", x = "Live weight (million t)") +
  facet_wrap(~habitat_method, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "none")

importer_decreases_plot <- top_import_decreases %>%
  ggplot(aes(x = change/1000000, y = importer_iso3c, fill = habitat_method, color = habitat_method)) +
  geom_segment(aes(x=0, xend=change/1000000, y=importer_iso3c, yend=importer_iso3c)) +
  geom_point(size=4) +
  scale_color_manual(values = habitat_source_colors) +
  scale_y_reordered() +
  labs(y = "", x = "Live weight (million t)") +
  facet_wrap(~habitat_method, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "none")

ggarrange(
  importer_decreases_plot, importer_increases_plot, nrow = 1
)

ggsave(file.path(outdir, "si_import_changes.png"))
```

```{r regional_avg_annual_change, fig.height = 4, fig.width = 4}
regional_avg_annual_change <- read.csv(file.path(datadir, "regional_avg_annual_change.csv"))

regional_slopes_ranked <- regional_avg_annual_change %>%
  ggplot(aes(x = slope/1000, y = exporter_importer, color = intraregion)) +
  geom_segment(aes(x=0, xend=slope/1000, y=exporter_importer, yend=exporter_importer, color = intraregion)) +
  geom_point(size=3) +
  scale_y_reordered() +
  scale_color_manual(values = habitat_source_colors[c(1,4)]) +
  labs(y = "", x = "Ave. annual change in export (1000 t live weight)", color = "") +
  theme_minimal() +
  theme(legend.position = "bottom")

regional_slopes_ranked
```

```{r custom_artis_ts}

artis_ts <- read.csv(file.path(datadir, "artis_ts.csv"))
custom_ts <- read.csv(file.path(datadir, "custom_ts.csv"))

ggplot() +
  geom_line(data = artis_ts, aes(x = year, y = live_weight_t, color = hs_version), linetype = "dashed", linewidth = 1) +
  geom_line(data = custom_ts, aes(x = year, y = live_weight_t, color = hs_version), linewidth = 0.5, linetype = "solid") +
  scale_color_manual(
    values = c("Custom ARTIS Time series" = "black", "HS96" = "#741A32", "HS02" = "#B34232", "HS07" = "#D38F35", "HS12" = "red", "HS17" = "#114F59")
  ) +
  labs(x = "Year", y = "Live Weight (tonnes)", color = "HS Version") +
  theme_bw() +
  theme(legend.position = "bottom")

ggsave(file.path(outdir, "custom_artis_ts.png"))
```

