---
title: "Supply diversity"
author: "Jessica Gephart"
date: "2023-03-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r prep_data}
# Figure 4
# Relationship between trade and supply diversity
diversity_dir <- "/Volumes/jgephart/ARTIS/Outputs/diversity/max_per_capita_100kg"
diversity <- read.csv(file.path(diversity_dir, "diversity.csv"))

# Figure 4a
# Time series of the Shannon diversity of imported blue foods and produced blue foods by region.
fig4a_data <- diversity %>%
  filter(region != "Other nei") %>%
  group_by(year, region) %>%
  summarise(shannon_prod = mean(shannon_prod),
            shannon_imports = mean(shannon_imports)) %>%
  pivot_longer(cols = shannon_prod:shannon_imports,
               names_to = "source", values_to = "shannon") %>%
  mutate(source = case_when(
    source == "shannon_prod" ~ "Production diversity",
    source == "shannon_imports" ~ "Import diversity"
  ))

write.csv(fig4a_data, file.path(outdir, "fig4a_data.csv"), row.names = FALSE)


# Figure 4b
# Foreign supply Shannon diversity versus domestic supply Shannon diversity for 2018.
# The black line represents the 1-to-1 line, such that points falling below the line
# indicate countries where the domestic supply diversity is greater than the foreign
# supply diversity.
fig4b_data <- diversity %>%
  filter(year == 2018, region != "Other nei")

write.csv(fig4b_data, file.path(outdir, "fig4b_data.csv"), row.names = FALSE)

# Figure 4c
# Relationship between total imports and overall supply diversity for 2018.
fig4c_data <- diversity %>%
  filter(year == 2018, region != "Other nei")

write.csv(fig4c_data, file.path(outdir, "fig4c_data.csv"), row.names = FALSE)
```


```{r fig4a_old, eval = FALSE}
fig4a_data <- read.csv(file.path(datadir, "fig4a_data.csv"))

fig4a <- fig4a_data %>%
  ggplot(aes(x = year, y = shannon, color = source)) +
  geom_line() +
  scale_color_manual(values = c(c("#F37542", "#0F2D59"))) +
  labs(x = "", y = "Shannon index", color = "") +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~region)

fig4a
```

```{r fig4a}
diversity <- read.csv("/Volumes/jgephart/ARTIS/Outputs/diversity/max_per_capita_100kg/diversity.csv")
fig4a <- diversity %>% 
  filter(year == 2019) %>%
  select(iso3c, region, "Production" = "shannon_prod", "Imports" = "shannon_imports", "Exports" = "shannon_exports") %>% 
  pivot_longer(Production:Exports, names_to = "shannon_var", values_to = "shannon_index") %>%
  mutate(shannon_var = factor(shannon_var, levels = c("Production", "Imports", "Exports"))) %>%
  ggplot(aes(x = shannon_var, y = shannon_index, fill = shannon_var)) +
  geom_violin() + 
  geom_point(alpha = 0.5) +
  scale_fill_manual(values = c(habitat_source_colors[1], habitat_source_colors[3], habitat_source_colors[4])) +
  labs(x = "", y = "Shannon index", fill = "") +
  facet_wrap(~region, nrow=1) +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        strip.background = element_blank(),
        text = element_text(size = 18)
        )
  
fig4a
```

```{r fig4b_old, eval=FALSE}
fig4b_data <- read.csv(file.path(datadir, "fig4b_data.csv"))

fig4b <- fig4b_data %>%
  ggplot(aes(x = shannon_domestic, y = shannon_foreign, color = region)) +
    geom_point(alpha = 0.7) +
    geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = region_colors) +
  labs(x = "Domestic supply diversity", 
       y = "Foreign supply diversity",
       color = "") +
    theme_minimal()

fig4b
```

```{r fig4b}
fig4b <- diversity %>% 
  filter(year == 2019) %>%
  select(iso3c, region, "Domestic" = "shannon_domestic", "Foreign" = "shannon_foreign") %>% 
  pivot_longer(Domestic:Foreign, names_to = "shannon_var", values_to = "shannon_index") %>%
  mutate(shannon_var = factor(shannon_var, levels = c("Domestic", "Foreign"))) %>%
  ggplot(aes(x = shannon_var, y = shannon_index, fill = shannon_var)) +
  geom_violin() + 
  geom_point(alpha = 0.5) +
  scale_fill_manual(values = c(habitat_source_colors[2], habitat_source_colors[4])) +
  labs(x = "", y = "Shannon index", fill = "") +
  facet_wrap(~region, nrow=1) +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        strip.background = element_blank(),
        text = element_text(size = 18))

fig4b
```


```{r fig4c}
fig4c_data <- read.csv(file.path(datadir, "fig4c_data.csv"))

fig4c <- fig4c_data %>%
  # total supply greater than 1 tonne (FIXIT update manuscript caption)
  filter(supply > 1) %>%
  ggplot(aes(x = imports/1000000, y = shannon_supply, color = region)) +
  geom_point(alpha = 0.7) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "b") +
  scale_color_manual(values = region_colors) +
  theme_minimal() +
  labs(x = "Total imports (million t, live weight)",
       y = "Supply diversity",
       color = "") +
  theme(
    text = element_text(size = 18)
  )

# 

fig4c
```
```{r fig4d}
fig4d_data <- read.csv(file.path(datadir, "fig4c_data.csv"))

fig4d <- fig4d_data %>%
  # total supply greater than 1 tonne (FIXIT update manuscript caption)
  filter(supply > 1) %>%
  ggplot(aes(x = exports/1000000, y = shannon_supply, color = region)) +
  geom_point(alpha = 0.7) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "b") +
  scale_color_manual(values = region_colors) +
  theme_minimal() +
  labs(x = "Total exports (million t, live weight)",
       y = "Supply diversity",
       color = "") +
  theme(
    text = element_text(size = 18)
  )

# 

fig4d
```

```{r fig4, fig.height = 5, fig.width = 7}
fig4 <- ggarrange(
  ggarrange(
    fig4a, fig4b,
    ncol = 1,
    nrow = 2,
    labels = c("a", "b")
  ),
  ggarrange(
    fig4c, fig4d,
    ncol = 1,
    nrow = 2,
    common.legend = TRUE,
    legend = "bottom",
    labels = c("c", "d")
  ),
  nrow = 1, ncol = 2,
  widths = c(1, 0.5)
)

fig4

ggsave(file.path(outdir, "fig4.png"))
```

```{r fig4_old, fig.height = 7, fig.width = 7, eval = FALSE}
fig4 <- ggarrange(fig4a,
                  fig4b,
          ggarrange(fig4d,
                    fig4e,
                    nrow = 1,
                    common.legend = TRUE, 
                    legend = "bottom",
                    labels = c("c", "d")),
          nrow = 3,
          labels = c("a", "b", "")
          )

fig4

ggsave(file.path(outdir, "fig4.png"))
```

High global diversity of aquatic food production enables high diversity in consumption, which is important for supplying a range of micronutrients, supporting a range of livelihoods, and is thought to support food system resilience (Seekell et al. 2017). However, one concern about food trade is that it homogenizes diets through two related pathways: by introducing foods that make diets more similar across countries and/or by out-competing diverse local foods. To explore this issue for aquatic foods, we compared the Shannon diversity index, of production versus imports and and exports (Fig 4a) and domestic supply versus foreign supply (Fig 4b). Across regions, import diversity is generally higher than production diversity and export diversity is similar to production diversity across regions (Fig 4a). Import diversity exceeds production diversity in `r n_import_exceeds_prod` out of `r nrow(national_supply_diversity)` countries. Although the diversity of imported goods tends to be higher than production, diversity of domestic-sourced consumption tends to be higher than  diversity of foreign sourced consumption (Fig 4b). Total imports and exports are positively associated with supply diversity across all regions (Fig 4c). This suggests trade is contributing new species to many national markets. Collectively, our diversity findings point to a need to protect domestic production diversity while still benefiting from the diversity of imported products. 


![Figure 4: Relationship between trade and supply diversity. a) Violin plots of the Shannon diversity of production, imports and exports for 2019. b) Violin plots of the Shannon diversity of domestic and foreign consumption for 2019. c) Relationship between total imports and overall supply diversity for 2019. d) Relationship between total exports and overall supply diversity for 2019. Note for figures 4c and 4d, only countries with a supply of at least 1 tonne were included.](outputs/fig4.png)

```{r}
national_supply_diversity <- read.csv(file.path(datadir, "fig4b_data.csv"))

n_import_exceeds_prod <- national_supply_diversity %>%
  filter(shannon_imports > shannon_prod) %>%
  nrow()

```


# Methods

## Estimating supply diversity
	We separately calculated the Shannon diversity for the overall supply, the diversity of supply sourced from domestic products, and the supply sourced from foreign products. Additionally, we calculated the Shannon diversity of domestic production, imports, and exports. One notable limitation of applying this measure is that instances where production or trade is only estimated at the genus or higher level will be interpreted in the calculation as a single species. Consequently, countries with low species resolution will generally appear to have less diverse production, limiting the ability to compare supply diversity across countries. To address this issue, we first matched scientific groups to species based on data in FishBase50 and SealifeBase53. We then calculated the global production distribution within each phylogenetic group based on a lognormal distribution of produced species. Proportions for each potential species within a phylogenetic group were derived from the lognormal global distribution. These proportions were matched to species in two ways. For species that had been previously reported by a country they were matched in order by the volume reported for that year and reported species were followed by the unreported species. This meant that, for a given year, the highest proportion derived from the lognormal distribution was matched to the species that the country had reported the largest volume for
