---
title: "ms_results"
author: "Jessica Gephart"
output: html_document
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Load packages
library(tidyverse)
library(countrycode)
library(kableExtra)
library(ggpubr)

# Set color palettes 
habitat_source_colors <- c("#1B708F", # blue = marine capture
                          "#86ADA7", # light blue = freshwater capture
                          "#F37542", # medium orange = marine aquaculture
                          "#F7AF75", # light orange = inland aquaculture
                          "grey50" # unknown
                          )
```

# Trends blue food globalization

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Load data summary files generated by ms_results
global_export_by_source <- read.csv("outputs/global_export_by_source.csv")
all_degree_summary <- read.csv("outputs/all_degree_summary.csv")
habitat_method_degree_summary <- read.csv("outputs/habitat_method_degree_summary.csv")

# Generate stats for text
total_1996 <- round(sum(global_export_by_source %>% filter(year == 1996) %>% pull(live_weight_t))/1000000, 1)
total_2019 <- round(sum(global_export_by_source %>% filter(year == 2019) %>% pull(live_weight_t))/1000000, 1)

total_capture_1996 <- round(sum(global_export_by_source %>% filter(year == 1996, str_detect(habitat_method, "capture")) %>% pull(live_weight_t))/1000000, 1)
total_capture_2019 <- round(sum(global_export_by_source %>% filter(year == 2019, str_detect(habitat_method, "capture")) %>% pull(live_weight_t))/1000000, 1)

total_marine_capture_1996 <- round(sum(global_export_by_source %>% filter(year == 1996, str_detect(habitat_method, "marine capture")) %>% pull(live_weight_t))/1000000, 1)
total_marine_capture_2019 <- round(sum(global_export_by_source %>% filter(year == 2019, str_detect(habitat_method, "marine capture")) %>% pull(live_weight_t))/1000000, 1)

total_inland_capture_1996 <- round(sum(global_export_by_source %>% filter(year == 1996, str_detect(habitat_method, "inland capture")) %>% pull(live_weight_t))/1000000, 1)
total_inland_capture_2019 <- round(sum(global_export_by_source %>% filter(year == 2019, str_detect(habitat_method, "inland capture")) %>% pull(live_weight_t))/1000000, 1)

total_aquaculture_1996 <- round(sum(global_export_by_source %>% filter(year == 1996, str_detect(habitat_method, "aquaculture")) %>% pull(live_weight_t))/1000000, 1)
total_aquaculture_2019 <- round(sum(global_export_by_source %>% filter(year == 2019, str_detect(habitat_method, "aquaculture")) %>% pull(live_weight_t))/1000000, 1)

total_marine_aquaculture_1996 <- round(sum(global_export_by_source %>% filter(year == 1996, str_detect(habitat_method, "marine aquaculture")) %>% pull(live_weight_t))/1000000, 1)
total_marine_aquaculture_2019 <- round(sum(global_export_by_source %>% filter(year == 2019, str_detect(habitat_method, "marine aquaculture")) %>% pull(live_weight_t))/1000000, 1)

total_inland_aquaculture_1996 <- round(sum(global_export_by_source %>% filter(year == 1996, str_detect(habitat_method, "inland aquaculture")) %>% pull(live_weight_t))/1000000, 1)
total_inland_aquaculture_2019 <- round(sum(global_export_by_source %>% filter(year == 2019, str_detect(habitat_method, "inland aquaculture")) %>% pull(live_weight_t))/1000000, 1)

total_fmfo_1996 <- round(sum(global_export_by_source %>% filter(year == 1996, food_or_fmfo == "fishmeal") %>% pull(live_weight_t))/1000000, 1)
total_fmfo_2019 <- round(sum(global_export_by_source %>% filter(year == 2019, food_or_fmfo == "fishmeal") %>% pull(live_weight_t))/1000000, 1)

all_degree_1996 <- mean(all_degree_summary %>% filter(year == 1996) %>% pull(all_out_degree), na.rm = TRUE)
all_degree_2019 <- mean(all_degree_summary %>% filter(year == 2019) %>% pull(all_out_degree), na.rm = TRUE)

```

## Text for MS

Globalization describes the degree of international connectedness, which can be characterized by the increasing flow of goods and number of trade relationships. Blue foods became increasingly globalized from 1996-2019, with exports increasing `r round(100*((total_2019-total_1996)/total_1996),0)`% (from `r total_1996` to `r total_2019` mil t) and the average number of trade partners increasing `r round(100*((all_degree_2019-all_degree_1996)/all_degree_1996),0)`%  (from `r round(all_degree_1996, 1)` to `r round(all_degree_2019, 1)`). Over that period, both farmed and wild exports increased, though aquaculture exports grew faster, more than tripling, whereas capture exports grew by `r round(100*((total_capture_2019-total_capture_1996)/total_capture_1996),0)`%. However, despite aquaculture now comprising half of blue food production, capture fishery products still dominate blue food exports, with capture products responsible for `r 100*round(total_capture_2019/total_2019, 1)`% of exports. Marine-sourced products dominate both capture and aquaculture exports, comprising `r round(100*total_marine_capture_2019/(total_marine_capture_2019+total_inland_capture_2019), 1)`% and `r round(100*total_marine_aquaculture_2019/(total_marine_aquaculture_2019+total_inland_aquaculture_2019), 1)`%, respectively. From 1996 to 2019, fishmeal exports remained relatively stable, declining `r abs(round(100*(total_fmfo_2019-total_fmfo_1996)/(total_fmfo_1996), 1))`%.

## Other summary stats
Global seafood trade increased from `r total_1996` million t (live weight) in 1996 to `r total_2019` million t (live weight) in 2019, representing a `r round(100*((total_2019-total_1996)/total_1996),0)`% increase over that period.

Global capture fishery trade increased from `r total_capture_1996` million t (live weight) in 1996 to `r total_capture_2019` million t (live weight) in 2019, representing a `r round(100*((total_capture_2019-total_capture_1996)/total_capture_1996),0)`% increase over that period. In 1996, capture fishery trade represented `r round(100*total_capture_1996/total_1996)`% of all seafood exports and by 2019 capture fishery exports represented `r round(100*total_capture_2019/total_2019)`% of all seafood exports. 

Global aquaculture fishery trade increased from `r total_aquaculture_1996` million t (live weight) in 1996 to `r total_aquaculture_2019` million t (live weight) in 2019, representing a `r round(100*((total_aquaculture_2019-total_aquaculture_1996)/total_aquaculture_1996),0)`% increase over that period. In 1996, aquaculture fishery trade represented `r round(100*total_aquaculture_1996/total_1996)`% of all seafood exports and by 2019 capture fishery exports represented `r round(100*total_aquaculture_2019/total_2019)`% of all seafood exports. 

# Shifts in global flows of blue foods
```{r, echo=FALSE, warning=FALSE, message=FALSE}
bilateral_habitat_method_summary <- read.csv("outputs/bilateral_habitat_method_summary.csv") %>% 
  # Set factor levels
  mutate(habitat_method = factor(habitat_method, levels = c("marine capture", "inland capture",
                                                            "marine aquaculture", "inland aquaculture",
                                                            "unknown" )))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
cumulative_percent_threshold <- 75
# Concentration in exports
## All
export_concentration <- bilateral_habitat_method_summary %>%
  group_by(year, exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(year, desc(live_weight_t)) %>%
  mutate(cumulative_percent = 100*cumsum(live_weight_t)/sum(live_weight_t))

export_concentration_n_countries <- export_concentration %>%
  filter(cumulative_percent < cumulative_percent_threshold) %>%
  group_by(year) %>% 
  tally()

## By habitat and method
export_concentration_habitat_method <- bilateral_habitat_method_summary %>%
  group_by(year, habitat_method, exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(year, habitat_method, desc(live_weight_t)) %>%
  mutate(cumulative_percent = 100*cumsum(live_weight_t)/sum(live_weight_t))

export_concentration_habitat_method_n_countries <- export_concentration_habitat_method %>%
  filter(cumulative_percent < cumulative_percent_threshold) %>%
  group_by(year, habitat_method) %>% 
  tally()

export_concentration_plot <- ggplot() +
  geom_line(data = export_concentration_habitat_method_n_countries %>% 
              filter(habitat_method != "unknown"), aes(x = year, y = n, color = habitat_method)) +
  scale_color_manual(values = habitat_source_colors) +
  geom_line(data = export_concentration_n_countries, aes(x = year, y = n), color = "black") +
  labs(x = "", y = paste("Number of countries comprising ", cumulative_percent_threshold, "% of exports", sep = ""), color = "Source") +
  lims(y = c(0, 30)) +
  theme_bw()

# Concentration in imports
## All
import_concentration <- bilateral_habitat_method_summary %>%
  group_by(year, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(year, desc(live_weight_t)) %>%
  mutate(cumulative_percent = 100*cumsum(live_weight_t)/sum(live_weight_t))

import_concentration_n_countries <- import_concentration %>%
  filter(cumulative_percent < cumulative_percent_threshold) %>%
  group_by(year) %>% 
  tally()

## By habitat and method
import_concentration_habitat_method <- bilateral_habitat_method_summary %>%
  group_by(year, habitat_method, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(year, habitat_method, desc(live_weight_t)) %>%
  mutate(cumulative_percent = 100*cumsum(live_weight_t)/sum(live_weight_t))

import_concentration_habitat_method_n_countries <- import_concentration_habitat_method %>%
  filter(cumulative_percent < cumulative_percent_threshold) %>%
  group_by(year, habitat_method) %>% 
  tally()

import_concentration_plot <- ggplot() +
  geom_line(data = import_concentration_habitat_method_n_countries %>% 
              filter(habitat_method != "unknown"), aes(x = year, y = n, color = habitat_method)) +
  scale_color_manual(values = habitat_source_colors) +
  geom_line(data = import_concentration_n_countries, aes(x = year, y = n), color = "black") +
  labs(x = "", y = paste("Number of countries comprising ", cumulative_percent_threshold, "% of imports", sep = ""), color = "Source") +
  lims(y = c(0, 30)) +
  theme_bw()

ggarrange(export_concentration_plot, import_concentration_plot, common.legend = TRUE, legend = "bottom", labels = c("a", "b"))
```

Since 1996, blue food exports and imports have become somewhat less concentrated, with only `r export_concentration_n_countries %>% filter(year == 1996) %>% pull(n)`countries comprising `r cumulative_percent_threshold`% of exports in 1996 versus `r export_concentration_n_countries %>% filter(year == 2019) %>% pull(n)` countries in 2019 and `r import_concentration_n_countries %>% filter(year == 1996) %>% pull(n)`countries comprising `r cumulative_percent_threshold`% of imports in 1996 versus `r import_concentration_n_countries %>% filter(year == 2019) %>% pull(n)` countries in 2019. Aquaculture exports and imports are generally concentrated among fewer countries than capture exports and imports, though inland aquaculture imports became less concentrated over the period.  

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Top trade tables
top_n_countries <- 5
top_n_countries_flows <- 10
top_n_regions <- 5
top_n_regions_flows <- 10

# Top exporters
## Countries
top_exporters_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996) %>%
  group_by(exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

top_exporters_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019) %>%
  group_by(exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

## Regions
top_region_exporters_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996) %>%
  group_by(exporter_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

top_region_exporters_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019) %>%
  group_by(exporter_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

# Top capture exporters
## Countries
top_capture_exporters_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

top_capture_exporters_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

## Regions
top_region_capture_exporters_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

top_region_capture_exporters_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

# Top aquaculture exporters
## Countries
top_aquaculture_exporters_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

top_aquaculture_exporters_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

## Regions
top_region_aquaculture_exporters_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

top_region_aquaculture_exporters_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

# Top importers
## Countries
top_importers_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996) %>%
  group_by(importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

top_importers_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019) %>%
  group_by(importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

## Regions
top_region_importers_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996) %>%
  group_by(importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

top_region_importers_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019) %>%
  group_by(importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

# Top capture importers
## Countries
top_capture_importers_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "capture")) %>%
  group_by(importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

top_capture_importers_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "capture")) %>%
  group_by(importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

## Regions
top_region_capture_importers_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "capture")) %>%
  group_by(importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

top_region_capture_importers_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "capture")) %>%
  group_by(importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

# Top aquaculture importers
## Countries
top_aquaculture_importers_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "aquaculture")) %>%
  group_by(importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

top_aquaculture_importers_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "aquaculture")) %>%
  group_by(importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

## Regions
top_region_aquaculture_importers_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "aquaculture")) %>%
  group_by(importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

top_region_aquaculture_importers_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "aquaculture")) %>%
  group_by(importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

# Top bilateral flows
## Countries
top_flows_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996) %>%
  group_by(exporter_iso3c, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries_flows, order_by = live_weight_t)

top_flows_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019) %>%
  group_by(exporter_iso3c, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries_flows, order_by = live_weight_t)

## Regions
top_region_flows_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996) %>%
  group_by(exporter_region, importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions_flows, order_by = live_weight_t)

top_region_flows_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019) %>%
  group_by(exporter_region, importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions_flows, order_by = live_weight_t)

# Top capture bilateral flows
## Countries
top_capture_flows_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_iso3c, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries_flows, order_by = live_weight_t)

top_capture_flows_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_iso3c, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries_flows, order_by = live_weight_t)

## Regions
top_region_capture_flows_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_region, importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions_flows, order_by = live_weight_t)

top_region_capture_flows_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_region, importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions_flows, order_by = live_weight_t)

# Top aquaculture bilateral flows
## Countries
top_aquaculture_flows_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_iso3c, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries_flows, order_by = live_weight_t)

top_aquaculture_flows_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_iso3c, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries_flows, order_by = live_weight_t)

## Regions
top_region_aquaculture_flows_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_region, importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions_flows, order_by = live_weight_t)

top_region_aquaculture_flows_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_region, importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions_flows, order_by = live_weight_t)

# Create tables
## Top exporter countries
top_exporter_table <- data.frame(rank = 1:top_n_countries) %>%
  left_join(top_exporters_1996 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_total_1996 = exporter_iso3c), by = "rank") %>%
  left_join(top_exporters_2019 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_total_2019 = exporter_iso3c), by = "rank") %>%
  left_join(top_capture_exporters_1996 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_capture_1996 = exporter_iso3c), by = "rank") %>%
  left_join(top_capture_exporters_2019 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_capture_2019 = exporter_iso3c), by = "rank") %>%
  left_join(top_aquaculture_exporters_1996 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_aquaculture_1996 = exporter_iso3c), by = "rank") %>%
  left_join(top_aquaculture_exporters_2019 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_aquaculture_2019 = exporter_iso3c), by = "rank") 

kable(top_exporter_table, 
      col.names = c("Rank", "All 1996", "All 2019", 
                    "Capture 1996", "Capture 2019", 
                    "Aqua 1996", "Aqua 2019"),
      caption = paste("Top", top_n_countries, "exporting countries for all blue foods, capture and aquaculture in 1996 versus 2019", sep = " ")) %>%
  kable_styling()

## Top exporter regions
top_exporter_region_table <- data.frame(rank = 1:top_n_regions) %>%
  left_join(top_region_exporters_1996 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_total_1996 = exporter_region), by = "rank") %>%
  left_join(top_region_exporters_2019 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_total_2019 = exporter_region), by = "rank") %>%
  left_join(top_region_capture_exporters_1996 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_capture_1996 = exporter_region), by = "rank") %>%
  left_join(top_region_capture_exporters_2019 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_capture_2019 = exporter_region), by = "rank") %>%
  left_join(top_region_aquaculture_exporters_1996 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_aquaculture_1996 = exporter_region), by = "rank") %>%
  left_join(top_region_aquaculture_exporters_2019 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_aquaculture_2019 = exporter_region), by = "rank") 

kable(top_exporter_region_table, 
      col.names = c("Rank", "All 1996", "All 2019", 
                    "Capture 1996", "Capture 2019", 
                    "Aqua 1996", "Aqua 2019"),
      caption = paste("Top", top_n_regions, "exporting regions for all blue foods, capture and aquaculture in 1996 versus 2019", sep = " ")) %>%
  kable_styling()

## Top importer countries
top_importer_table <- data.frame(rank = 1:top_n_countries) %>%
  left_join(top_importers_1996 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_total_1996 = importer_iso3c), by = "rank") %>%
  left_join(top_importers_2019 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_total_2019 = importer_iso3c), by = "rank") %>%
  left_join(top_capture_importers_1996 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_capture_1996 = importer_iso3c), by = "rank") %>%
  left_join(top_capture_importers_2019 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_capture_2019 = importer_iso3c), by = "rank") %>%
  left_join(top_aquaculture_importers_1996 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_aquaculture_1996 = importer_iso3c), by = "rank") %>%
  left_join(top_aquaculture_importers_2019 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_aquaculture_2019 = importer_iso3c), by = "rank") 

kable(top_importer_table, 
      col.names = c("Rank", "All 1996", "All 2019", 
                    "Capture 1996", "Capture 2019", 
                    "Aqua 1996", "Aqua 2019"),
      caption = paste("Top", top_n_countries, "importing countries for all blue foods, capture and aquaculture in 1996 versus 2019", sep = " ")) %>%
  kable_styling()


## Top importer regions
top_importer_region_table <- data.frame(rank = 1:top_n_regions) %>%
  left_join(top_region_importers_1996 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_total_1996 = importer_region), by = "rank") %>%
  left_join(top_region_importers_2019 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_total_2019 = importer_region), by = "rank") %>%
  left_join(top_region_capture_importers_1996 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_capture_1996 = importer_region), by = "rank") %>%
  left_join(top_region_capture_importers_2019 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_capture_2019 = importer_region), by = "rank") %>%
  left_join(top_region_aquaculture_importers_1996 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_aquaculture_1996 = importer_region), by = "rank") %>%
  left_join(top_region_aquaculture_importers_2019 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_aquaculture_2019 = importer_region), by = "rank") 

kable(top_importer_region_table, 
      col.names = c("Rank", "All 1996", "All 2019", 
                    "Capture 1996", "Capture 2019", 
                    "Aqua 1996", "Aqua 2019"),
      caption = paste("Top", top_n_regions, "importing regions for all blue foods, capture and aquaculture in 1996 versus 2019", sep = " ")) %>%
  kable_styling()


## Top country flows
top_country_flow_table <- data.frame(rank = 1:top_n_countries_flows) %>%
  left_join(top_flows_1996 %>% 
              mutate(rank = 1:top_n_countries_flows,
                     top_total_1996 = paste(exporter_iso3c, "to", importer_iso3c, sep =" ")) %>%
              select(rank, top_total_1996), by = "rank") %>%
  left_join(top_flows_2019 %>% 
              mutate(rank = 1:top_n_countries_flows,
                     top_total_2019 = paste(exporter_iso3c, "to", importer_iso3c, sep =" ")) %>%
              select(rank, top_total_2019), by = "rank") %>%
  left_join(top_capture_flows_1996 %>% 
              mutate(rank = 1:top_n_countries_flows,
                     top_capture_1996 = paste(exporter_iso3c, "to", importer_iso3c, sep =" ")) %>%
              select(rank, top_capture_1996), by = "rank") %>%
  left_join(top_capture_flows_2019 %>% 
              mutate(rank = 1:top_n_countries_flows,
                     top_capture_2019 = paste(exporter_iso3c, "to", importer_iso3c, sep =" ")) %>%
              select(rank, top_capture_2019), by = "rank") %>%
  left_join(top_aquaculture_flows_1996 %>% 
              mutate(rank = 1:top_n_countries_flows,
                     top_aquaculture_1996 = paste(exporter_iso3c, "to", importer_iso3c, sep =" ")) %>%
              select(rank, top_aquaculture_1996), by = "rank") %>%
  left_join(top_aquaculture_flows_2019 %>% 
              mutate(rank = 1:top_n_countries_flows,
                     top_aquaculture_2019 = paste(exporter_iso3c, "to", importer_iso3c, sep =" ")) %>%
              select(rank, top_aquaculture_2019), by = "rank") 

kable(top_country_flow_table, 
      col.names = c("Rank", "All 1996", "All 2019", 
                    "Capture 1996", "Capture 2019", 
                    "Aqua 1996", "Aqua 2019"),
      caption = paste("Top", top_n_countries_flows, "country trade flows for all blue foods, capture and aquaculture in 1996 versus 2019", sep = " ")) %>%
  kable_styling()

## Top region flows
top_region_flow_table <- data.frame(rank = 1:top_n_regions_flows) %>%
  left_join(top_region_flows_1996 %>% 
              mutate(rank = 1:top_n_regions_flows,
                     top_total_1996 = paste(exporter_region, "to", importer_region, sep = " ")) %>%
              select(rank, top_total_1996), by = "rank") %>%
  left_join(top_region_flows_2019 %>% 
              mutate(rank = 1:top_n_regions_flows,
                     top_total_2019 = paste(exporter_region, "to", importer_region, sep = " ")) %>%
              select(rank, top_total_2019), by = "rank") %>%
  left_join(top_region_capture_flows_1996 %>% 
              mutate(rank = 1:top_n_regions_flows,
                     top_capture_1996 = paste(exporter_region, "to", importer_region, sep = " ")) %>%
              select(rank, top_capture_1996), by = "rank") %>%
  left_join(top_region_capture_flows_2019 %>% 
              mutate(rank = 1:top_n_regions_flows,
                     top_capture_2019 = paste(exporter_region, "to", importer_region, sep = " ")) %>%
              select(rank, top_capture_2019), by = "rank") %>%
  left_join(top_region_aquaculture_flows_1996 %>% 
              mutate(rank = 1:top_n_regions_flows,
                     top_aquaculture_1996 = paste(exporter_region, "to", importer_region, sep = " ")) %>%
              select(rank, top_aquaculture_1996), by = "rank") %>%
  left_join(top_region_aquaculture_flows_2019 %>% 
              mutate(rank = 1:top_n_regions_flows,
                     top_aquaculture_2019 = paste(exporter_region, "to", importer_region, sep = " ")) %>%
              select(rank, top_aquaculture_2019), by = "rank") 

kable(top_region_flow_table, 
      col.names = c("Rank", "All 1996", "All 2019", 
                    "Capture 1996", "Capture 2019", 
                    "Aqua 1996", "Aqua 2019"),
      caption = paste("Top", top_n_regions_flows, "country trade flows for all blue foods, capture and aquaculture in 1996 versus 2019", sep = " ")) %>%
  kable_styling()
  
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
bilateral_habitat_method_summary %>% 
  filter(exporter_region != "Other nei", importer_region != "Other nei") %>%
  filter(year %in% 2015:2019) %>%
  group_by(exporter_region, importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  group_by(exporter_region) %>%
  slice_max(n=2, order_by = live_weight_t)

bilateral_habitat_method_summary %>% 
  filter(exporter_region != "Other nei", importer_region != "Other nei") %>%
  filter(year %in% 2015:2019) %>%
  group_by(exporter_region, importer_region, habitat_method) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  group_by(exporter_region, habitat_method) %>%
  slice_max(n=1, order_by = live_weight_t)
```

For all regions other than Oceania and South America, interregional trade is either the highest or second high

## Text for MS

## Other summary stats

# Role of trade in national blue food supplies

## Text for MS

## Other summary stats

# Trade and blue food supply diversity

## Text for MS

## Other summary stats


