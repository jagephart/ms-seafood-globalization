---
title: "ms_results"
author: "Jessica Gephart"
output: html_document
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Load packages
library(tidyverse)
library(countrycode)
library(kableExtra)
library(ggpubr)
library(tidytext)

# Set color palettes 
habitat_source_colors <- c("#1B708F", # blue = marine capture
                          "#86ADA7", # light blue = freshwater capture
                          "#F37542", # medium orange = marine aquaculture
                          "#F7AF75", # light orange = inland aquaculture
                          "grey50" # unknown
                          )
```

# Trends blue food globalization

```{r trends_summary}
# Generate summary statistics for total trade trends

# Load data summary files generated by ms_results
global_export_by_source <- read.csv("outputs/global_export_by_source.csv")
all_degree_summary <- read.csv("outputs/all_degree_summary.csv")
habitat_method_degree_summary <- read.csv("outputs/habitat_method_degree_summary.csv")

# Generate stats for text
total_1996 <- round(sum(global_export_by_source %>% filter(year == 1996) %>% pull(live_weight_t))/1000000, 1)
total_2019 <- round(sum(global_export_by_source %>% filter(year == 2019) %>% pull(live_weight_t))/1000000, 1)

total_capture_1996 <- round(sum(global_export_by_source %>% filter(year == 1996, str_detect(habitat_method, "capture")) %>% pull(live_weight_t))/1000000, 1)
total_capture_2019 <- round(sum(global_export_by_source %>% filter(year == 2019, str_detect(habitat_method, "capture")) %>% pull(live_weight_t))/1000000, 1)

total_marine_capture_1996 <- round(sum(global_export_by_source %>% filter(year == 1996, str_detect(habitat_method, "marine capture")) %>% pull(live_weight_t))/1000000, 1)
total_marine_capture_2019 <- round(sum(global_export_by_source %>% filter(year == 2019, str_detect(habitat_method, "marine capture")) %>% pull(live_weight_t))/1000000, 1)

total_inland_capture_1996 <- round(sum(global_export_by_source %>% filter(year == 1996, str_detect(habitat_method, "inland capture")) %>% pull(live_weight_t))/1000000, 1)
total_inland_capture_2019 <- round(sum(global_export_by_source %>% filter(year == 2019, str_detect(habitat_method, "inland capture")) %>% pull(live_weight_t))/1000000, 1)

total_aquaculture_1996 <- round(sum(global_export_by_source %>% filter(year == 1996, str_detect(habitat_method, "aquaculture")) %>% pull(live_weight_t))/1000000, 1)
total_aquaculture_2019 <- round(sum(global_export_by_source %>% filter(year == 2019, str_detect(habitat_method, "aquaculture")) %>% pull(live_weight_t))/1000000, 1)

total_marine_aquaculture_1996 <- round(sum(global_export_by_source %>% filter(year == 1996, str_detect(habitat_method, "marine aquaculture")) %>% pull(live_weight_t))/1000000, 1)
total_marine_aquaculture_2019 <- round(sum(global_export_by_source %>% filter(year == 2019, str_detect(habitat_method, "marine aquaculture")) %>% pull(live_weight_t))/1000000, 1)

total_inland_aquaculture_1996 <- round(sum(global_export_by_source %>% filter(year == 1996, str_detect(habitat_method, "inland aquaculture")) %>% pull(live_weight_t))/1000000, 1)
total_inland_aquaculture_2019 <- round(sum(global_export_by_source %>% filter(year == 2019, str_detect(habitat_method, "inland aquaculture")) %>% pull(live_weight_t))/1000000, 1)

total_fmfo_1996 <- round(sum(global_export_by_source %>% filter(year == 1996, food_or_fmfo == "fishmeal") %>% pull(live_weight_t))/1000000, 1)
total_fmfo_2019 <- round(sum(global_export_by_source %>% filter(year == 2019, food_or_fmfo == "fishmeal") %>% pull(live_weight_t))/1000000, 1)

```

```{r percent_export_by_source_trends}
percent_export_by_source <- read.csv("outputs/percent_export_by_source_summary.csv")
percent_export_total <- read.csv("outputs/percent_export_total_summary.csv")

percent_export_total_dom_1996 <- percent_export_total %>% 
  filter(year == 1996, calc_type == "domestic exports") %>% 
  pull(percent_export)
percent_export_total_dom_2019 <- percent_export_total %>% 
  filter(year == 2019, calc_type == "domestic exports") %>% 
  pull(percent_export)

percent_export_total_1996 <- percent_export_total %>% 
  filter(year == 1996, calc_type == "all export sources") %>% 
  pull(percent_export)
percent_export_total_2019 <- percent_export_total %>% 
  filter(year == 2019, calc_type == "all export sources") %>% 
  pull(percent_export)

percent_marine_capture_exported_1996 <- percent_export_by_source %>% 
  filter(year == 1996, habitat_method == "marine capture") %>%
  pull(percent_export)
percent_marine_capture_exported_2019 <- percent_export_by_source %>% 
  filter(year == 2019, habitat_method == "marine capture") %>%
  pull(percent_export)

percent_marine_aqua_exported_1996 <- percent_export_by_source %>% 
  filter(year == 1996, habitat_method == "marine aquaculture") %>%
  pull(percent_export)
percent_marine_aqua_exported_2019 <- percent_export_by_source %>% 
  filter(year == 2019, habitat_method == "marine aquaculture") %>%
  pull(percent_export)

percent_inland_capture_exported_1996 <- percent_export_by_source %>% 
  filter(year == 1996, habitat_method == "inland capture") %>%
  pull(percent_export)
percent_inland_capture_exported_2019 <- percent_export_by_source %>% 
  filter(year == 2019, habitat_method == "inland capture") %>%
  pull(percent_export)

percent_inland_aqua_exported_1996 <- percent_export_by_source %>% 
  filter(year == 1996, habitat_method == "inland aquaculture") %>%
  pull(percent_export)
percent_inland_aqua_exported_2019 <- percent_export_by_source %>% 
  filter(year == 2019, habitat_method == "inland aquaculture") %>%
  pull(percent_export)

```

```{r trends_concentration}
# Calculate import/export concentration stats

# Load data as bilateral flows by habitat and method
bilateral_habitat_method_summary <- read.csv("outputs/bilateral_habitat_method_summary.csv") %>% 
  # Set factor levels
  mutate(habitat_method = factor(habitat_method, levels = c("marine capture", "inland capture",
                                                            "marine aquaculture", "inland aquaculture",
                                                            "unknown" )))
# Set percent threshold
cumulative_percent_threshold <- 75
# Concentration in exports
## All
export_concentration <- bilateral_habitat_method_summary %>%
  group_by(year, exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(year, desc(live_weight_t)) %>%
  mutate(cumulative_percent = 100*cumsum(live_weight_t)/sum(live_weight_t))

export_concentration_n_countries <- export_concentration %>%
  filter(cumulative_percent < cumulative_percent_threshold) %>%
  group_by(year) %>% 
  tally()

## By habitat and method
export_concentration_habitat_method <- bilateral_habitat_method_summary %>%
  group_by(year, habitat_method, exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(year, habitat_method, desc(live_weight_t)) %>%
  mutate(cumulative_percent = 100*cumsum(live_weight_t)/sum(live_weight_t))

export_concentration_habitat_method_n_countries <- export_concentration_habitat_method %>%
  filter(cumulative_percent < cumulative_percent_threshold) %>%
  group_by(year, habitat_method) %>% 
  tally()

export_concentration_plot <- ggplot() +
  geom_line(data = export_concentration_habitat_method_n_countries %>% 
              filter(habitat_method != "unknown"), aes(x = year, y = n, color = habitat_method)) +
  scale_color_manual(values = habitat_source_colors) +
  geom_line(data = export_concentration_n_countries, aes(x = year, y = n), color = "black") +
  labs(x = "", y = paste("Number of countries comprising ", cumulative_percent_threshold, "% of exports", sep = ""), color = "Source") +
  lims(y = c(0, 30)) +
  theme_bw()

# Concentration in imports
## All
import_concentration <- bilateral_habitat_method_summary %>%
  group_by(year, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(year, desc(live_weight_t)) %>%
  mutate(cumulative_percent = 100*cumsum(live_weight_t)/sum(live_weight_t))

import_concentration_n_countries <- import_concentration %>%
  filter(cumulative_percent < cumulative_percent_threshold) %>%
  group_by(year) %>% 
  tally()

## By habitat and method
import_concentration_habitat_method <- bilateral_habitat_method_summary %>%
  group_by(year, habitat_method, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(year, habitat_method, desc(live_weight_t)) %>%
  mutate(cumulative_percent = 100*cumsum(live_weight_t)/sum(live_weight_t))

import_concentration_habitat_method_n_countries <- import_concentration_habitat_method %>%
  filter(cumulative_percent < cumulative_percent_threshold) %>%
  group_by(year, habitat_method) %>% 
  tally()

import_concentration_plot <- ggplot() +
  geom_line(data = import_concentration_habitat_method_n_countries %>% 
              filter(habitat_method != "unknown"), aes(x = year, y = n, color = habitat_method)) +
  scale_color_manual(values = habitat_source_colors) +
  geom_line(data = import_concentration_n_countries, aes(x = year, y = n), color = "black") +
  labs(x = "", y = paste("Number of countries comprising ", cumulative_percent_threshold, "% of imports", sep = ""), color = "Source") +
  lims(y = c(0, 30)) +
  theme_bw()

ggarrange(export_concentration_plot, import_concentration_plot, common.legend = TRUE, legend = "bottom", labels = c("a", "b"))
```

```{r degree_summary_stats}
all_degree_1996 <- all_degree_summary %>%
  filter(year == 1996) %>% 
  summarise(all_out_degree = mean(all_out_degree, na.rm = TRUE)) %>%
  pull(all_out_degree)

all_degree_2019 <- all_degree_summary %>%
  filter(year == 2019) %>% 
  summarise(all_out_degree = mean(all_out_degree, na.rm = TRUE)) %>%
  pull(all_out_degree)
  

```


## Text for MS

Globalization describes the degree of international connectedness, which can be characterized by the increasing flow of goods and number of trade relationships. Blue foods became increasingly globalized from 1996-2019, with exports increasing `r round(100*((total_2019-total_1996)/total_1996),0)`%  (from `r total_1996` to `r total_2019` mil t) and the average number of export partners increasing `r round(100*((all_degree_2019-all_degree_1996)/all_degree_1996),0)`%  (from `r round(all_degree_1996, 1)` to `r round(all_degree_2019, 1)`) since 1996. Over that period, both farmed and wild exports increased, though aquaculture exports grew faster, more than tripling, whereas capture exports grew by `r round(100*((total_capture_2019-total_capture_1996)/total_capture_1996),0)`%. However, despite aquaculture now comprising half of blue food production, capture fishery products still dominate blue food exports, with capture products responsible for `r 100*round(total_capture_2019/total_2019, 1)`% of exports. Marine-sourced products dominate both capture and aquaculture exports, comprising `r round(100*total_marine_capture_2019/(total_marine_capture_2019+total_inland_capture_2019), 1)`% and `r round(100*total_marine_aquaculture_2019/(total_marine_aquaculture_2019+total_inland_aquaculture_2019), 1)`%, respectively. From 1996 to 2019, fishmeal exports remained relatively stable, declining `r abs(round(100*(total_fmfo_2019-total_fmfo_1996)/(total_fmfo_1996), 1))`% over the time period. Consequently, the share of global blue food exports represented by fishmeal declined from `r abs(round(100*(total_fmfo_1996)/(total_1996), 1))`% in 1996 to only `r abs(round(100*(total_fmfo_2019)/(total_2019), 1))`% in 2019. 

Another measure of the degree of globalization is the share of production exported. Domestic exports increased to `r round(percent_export_total_dom_2019, 1)`% of production in 2019 while total exports (i.e., domestic plus exports of foreign and unknown origin) reached `r round(percent_export_total_2019, 1)`% of all production. For comparison, the share of cereal production exported grew from around 10% in the late 1990s to 17% in the 2020s (Clapp 2022). Marine capture products have the greatest share of production destined for export (domestic exports represented `r round(percent_marine_capture_exported_2019, 1)`% of production) and experienced the largest increases in the share exported, while inland aquaculture had the lowest share of production destined for export (domestic exports represented only `r round(percent_inland_aqua_exported_2019, 1)`% of production) (Fig 1b). 

One concern for increasing globalization is that it may create systemic risks from shocks, particularly when trade is highly concentrated. Since 1996, blue food exports and imports have become somewhat less concentrated, with only `r export_concentration_n_countries %>% filter(year == 1996) %>% pull(n)` countries comprising `r cumulative_percent_threshold`% of exports in 1996 versus `r export_concentration_n_countries %>% filter(year == 2019) %>% pull(n)` countries in 2019 and `r import_concentration_n_countries %>% filter(year == 1996) %>% pull(n)` countries comprising `r cumulative_percent_threshold`% of imports in 1996 versus `r import_concentration_n_countries %>% filter(year == 2019) %>% pull(n)` countries in 2019. Compare this with crops where just 7 countries and the EU account for 90% of wheat exports and just four countries accounting >80% of maize exports (Clapp 2022). Aquaculture exports are generally concentrated among fewer countries than capture exports, corresponding to the high concentration of aquaculture production. However, inland aquaculture imports have become less concentrated over time. The more dispersed trade patterns can be attributed to expanding middle classes and urbanization, particularly in low- and middle-income countries, which are responsible for increasing blue food demand in many countries (Naylor et al. 2021; SOFIA 2022). [Roz - maybe we can come up with an illustrative example from the BFA demand paper for here?]

## Other summary stats
Global seafood trade increased from `r total_1996` million t (live weight) in 1996 to `r total_2019` million t (live weight) in 2019, representing a `r round(100*((total_2019-total_1996)/total_1996),0)`% increase over that period.

Global capture fishery trade increased from `r total_capture_1996` million t (live weight) in 1996 to `r total_capture_2019` million t (live weight) in 2019, representing a `r round(100*((total_capture_2019-total_capture_1996)/total_capture_1996),0)`% increase over that period. In 1996, capture fishery trade represented `r round(100*total_capture_1996/total_1996)`% of all seafood exports and by 2019 capture fishery exports represented `r round(100*total_capture_2019/total_2019)`% of all seafood exports. 

Global aquaculture fishery trade increased from `r total_aquaculture_1996` million t (live weight) in 1996 to `r total_aquaculture_2019` million t (live weight) in 2019, representing a `r round(100*((total_aquaculture_2019-total_aquaculture_1996)/total_aquaculture_1996),0)`% increase over that period. In 1996, aquaculture fishery trade represented `r round(100*total_aquaculture_1996/total_1996)`% of all seafood exports and by 2019 capture fishery exports represented `r round(100*total_aquaculture_2019/total_2019)`% of all seafood exports. 

```{r covid_effect}
# artis %>% 
#   filter(year %in% 2019:2020) %>% 
#   group_by(year, habitat_method) %>% 
#   summarise(live_weight_t = sum(live_weight_t)) %>% 
#   pivot_wider(names_from = year, values_from = live_weight_t, names_prefix = "year") %>% 
#   mutate(change = (year2019-year2020)/year2020) %>% 
#   arrange(desc(change))
```


# Shifts in global flows of blue foods

```{r top_traders}
# Top trade tables
top_n_countries <- 5
top_n_countries_flows <- 10
top_n_regions <- 5
top_n_regions_flows <- 10

# Top exporters
## Countries
top_exporters_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996) %>%
  group_by(exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

top_exporters_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019) %>%
  group_by(exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

## Regions
top_region_exporters_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996) %>%
  group_by(exporter_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

top_region_exporters_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019) %>%
  group_by(exporter_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

# Top capture exporters
## Countries
top_capture_exporters_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

top_capture_exporters_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

## Regions
top_region_capture_exporters_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

top_region_capture_exporters_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

# Top aquaculture exporters
## Countries
top_aquaculture_exporters_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

top_aquaculture_exporters_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

## Regions
top_region_aquaculture_exporters_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

top_region_aquaculture_exporters_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

# Top importers
## Countries
top_importers_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996) %>%
  group_by(importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

top_importers_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019) %>%
  group_by(importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

## Regions
top_region_importers_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996) %>%
  group_by(importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

top_region_importers_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019) %>%
  group_by(importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

# Top capture importers
## Countries
top_capture_importers_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "capture")) %>%
  group_by(importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

top_capture_importers_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "capture")) %>%
  group_by(importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

## Regions
top_region_capture_importers_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "capture")) %>%
  group_by(importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

top_region_capture_importers_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "capture")) %>%
  group_by(importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

# Top aquaculture importers
## Countries
top_aquaculture_importers_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "aquaculture")) %>%
  group_by(importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

top_aquaculture_importers_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "aquaculture")) %>%
  group_by(importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries, order_by = live_weight_t)

## Regions
top_region_aquaculture_importers_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "aquaculture")) %>%
  group_by(importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

top_region_aquaculture_importers_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "aquaculture")) %>%
  group_by(importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions, order_by = live_weight_t)

# Top bilateral flows
## Countries
top_flows_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996) %>%
  group_by(exporter_iso3c, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries_flows, order_by = live_weight_t)

top_flows_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019) %>%
  group_by(exporter_iso3c, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries_flows, order_by = live_weight_t)

## Regions
top_region_flows_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996) %>%
  group_by(exporter_region, importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions_flows, order_by = live_weight_t)

top_region_flows_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019) %>%
  group_by(exporter_region, importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions_flows, order_by = live_weight_t)

# Top capture bilateral flows
## Countries
top_capture_flows_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_iso3c, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries_flows, order_by = live_weight_t)

top_capture_flows_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_iso3c, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries_flows, order_by = live_weight_t)

## Regions
top_region_capture_flows_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_region, importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions_flows, order_by = live_weight_t)

top_region_capture_flows_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "capture")) %>%
  group_by(exporter_region, importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions_flows, order_by = live_weight_t)

# Top aquaculture bilateral flows
## Countries
top_aquaculture_flows_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_iso3c, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries_flows, order_by = live_weight_t)

top_aquaculture_flows_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_iso3c, importer_iso3c) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_countries_flows, order_by = live_weight_t)

## Regions
top_region_aquaculture_flows_1996 <- bilateral_habitat_method_summary %>%
  filter(year == 1996, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_region, importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions_flows, order_by = live_weight_t)

top_region_aquaculture_flows_2019 <- bilateral_habitat_method_summary %>%
  filter(year == 2019, str_detect(habitat_method, "aquaculture")) %>%
  group_by(exporter_region, importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  arrange(desc(live_weight_t)) %>%
  slice_max(n = top_n_regions_flows, order_by = live_weight_t)

# Create tables
## Top exporter countries
top_exporter_table <- data.frame(rank = 1:top_n_countries) %>%
  left_join(top_exporters_1996 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_total_1996 = exporter_iso3c), by = "rank") %>%
  left_join(top_exporters_2019 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_total_2019 = exporter_iso3c), by = "rank") %>%
  left_join(top_capture_exporters_1996 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_capture_1996 = exporter_iso3c), by = "rank") %>%
  left_join(top_capture_exporters_2019 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_capture_2019 = exporter_iso3c), by = "rank") %>%
  left_join(top_aquaculture_exporters_1996 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_aquaculture_1996 = exporter_iso3c), by = "rank") %>%
  left_join(top_aquaculture_exporters_2019 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_aquaculture_2019 = exporter_iso3c), by = "rank") 

kable(top_exporter_table, 
      col.names = c("Rank", "All 1996", "All 2019", 
                    "Capture 1996", "Capture 2019", 
                    "Aqua 1996", "Aqua 2019"),
      caption = paste("Top", top_n_countries, "exporting countries for all blue foods, capture and aquaculture in 1996 versus 2019", sep = " ")) %>%
  kable_styling()

## Top exporter regions
top_exporter_region_table <- data.frame(rank = 1:top_n_regions) %>%
  left_join(top_region_exporters_1996 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_total_1996 = exporter_region), by = "rank") %>%
  left_join(top_region_exporters_2019 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_total_2019 = exporter_region), by = "rank") %>%
  left_join(top_region_capture_exporters_1996 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_capture_1996 = exporter_region), by = "rank") %>%
  left_join(top_region_capture_exporters_2019 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_capture_2019 = exporter_region), by = "rank") %>%
  left_join(top_region_aquaculture_exporters_1996 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_aquaculture_1996 = exporter_region), by = "rank") %>%
  left_join(top_region_aquaculture_exporters_2019 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_aquaculture_2019 = exporter_region), by = "rank") 

kable(top_exporter_region_table, 
      col.names = c("Rank", "All 1996", "All 2019", 
                    "Capture 1996", "Capture 2019", 
                    "Aqua 1996", "Aqua 2019"),
      caption = paste("Top", top_n_regions, "exporting regions for all blue foods, capture and aquaculture in 1996 versus 2019", sep = " ")) %>%
  kable_styling()

## Top importer countries
top_importer_table <- data.frame(rank = 1:top_n_countries) %>%
  left_join(top_importers_1996 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_total_1996 = importer_iso3c), by = "rank") %>%
  left_join(top_importers_2019 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_total_2019 = importer_iso3c), by = "rank") %>%
  left_join(top_capture_importers_1996 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_capture_1996 = importer_iso3c), by = "rank") %>%
  left_join(top_capture_importers_2019 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_capture_2019 = importer_iso3c), by = "rank") %>%
  left_join(top_aquaculture_importers_1996 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_aquaculture_1996 = importer_iso3c), by = "rank") %>%
  left_join(top_aquaculture_importers_2019 %>% 
              mutate(rank = 1:top_n_countries) %>%
              select(rank, top_aquaculture_2019 = importer_iso3c), by = "rank") 

kable(top_importer_table, 
      col.names = c("Rank", "All 1996", "All 2019", 
                    "Capture 1996", "Capture 2019", 
                    "Aqua 1996", "Aqua 2019"),
      caption = paste("Top", top_n_countries, "importing countries for all blue foods, capture and aquaculture in 1996 versus 2019", sep = " ")) %>%
  kable_styling()


## Top importer regions
top_importer_region_table <- data.frame(rank = 1:top_n_regions) %>%
  left_join(top_region_importers_1996 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_total_1996 = importer_region), by = "rank") %>%
  left_join(top_region_importers_2019 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_total_2019 = importer_region), by = "rank") %>%
  left_join(top_region_capture_importers_1996 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_capture_1996 = importer_region), by = "rank") %>%
  left_join(top_region_capture_importers_2019 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_capture_2019 = importer_region), by = "rank") %>%
  left_join(top_region_aquaculture_importers_1996 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_aquaculture_1996 = importer_region), by = "rank") %>%
  left_join(top_region_aquaculture_importers_2019 %>% 
              mutate(rank = 1:top_n_regions) %>%
              select(rank, top_aquaculture_2019 = importer_region), by = "rank") 

kable(top_importer_region_table, 
      col.names = c("Rank", "All 1996", "All 2019", 
                    "Capture 1996", "Capture 2019", 
                    "Aqua 1996", "Aqua 2019"),
      caption = paste("Top", top_n_regions, "importing regions for all blue foods, capture and aquaculture in 1996 versus 2019", sep = " ")) %>%
  kable_styling()


## Top country flows
top_country_flow_table <- data.frame(rank = 1:top_n_countries_flows) %>%
  left_join(top_flows_1996 %>% 
              mutate(rank = 1:top_n_countries_flows,
                     top_total_1996 = paste(exporter_iso3c, "to", importer_iso3c, sep =" ")) %>%
              select(rank, top_total_1996), by = "rank") %>%
  left_join(top_flows_2019 %>% 
              mutate(rank = 1:top_n_countries_flows,
                     top_total_2019 = paste(exporter_iso3c, "to", importer_iso3c, sep =" ")) %>%
              select(rank, top_total_2019), by = "rank") %>%
  left_join(top_capture_flows_1996 %>% 
              mutate(rank = 1:top_n_countries_flows,
                     top_capture_1996 = paste(exporter_iso3c, "to", importer_iso3c, sep =" ")) %>%
              select(rank, top_capture_1996), by = "rank") %>%
  left_join(top_capture_flows_2019 %>% 
              mutate(rank = 1:top_n_countries_flows,
                     top_capture_2019 = paste(exporter_iso3c, "to", importer_iso3c, sep =" ")) %>%
              select(rank, top_capture_2019), by = "rank") %>%
  left_join(top_aquaculture_flows_1996 %>% 
              mutate(rank = 1:top_n_countries_flows,
                     top_aquaculture_1996 = paste(exporter_iso3c, "to", importer_iso3c, sep =" ")) %>%
              select(rank, top_aquaculture_1996), by = "rank") %>%
  left_join(top_aquaculture_flows_2019 %>% 
              mutate(rank = 1:top_n_countries_flows,
                     top_aquaculture_2019 = paste(exporter_iso3c, "to", importer_iso3c, sep =" ")) %>%
              select(rank, top_aquaculture_2019), by = "rank") 

kable(top_country_flow_table, 
      col.names = c("Rank", "All 1996", "All 2019", 
                    "Capture 1996", "Capture 2019", 
                    "Aqua 1996", "Aqua 2019"),
      caption = paste("Top", top_n_countries_flows, "country trade flows for all blue foods, capture and aquaculture in 1996 versus 2019", sep = " ")) %>%
  kable_styling()

## Top region flows
top_region_flow_table <- data.frame(rank = 1:top_n_regions_flows) %>%
  left_join(top_region_flows_1996 %>% 
              mutate(rank = 1:top_n_regions_flows,
                     top_total_1996 = paste(exporter_region, "to", importer_region, sep = " ")) %>%
              select(rank, top_total_1996), by = "rank") %>%
  left_join(top_region_flows_2019 %>% 
              mutate(rank = 1:top_n_regions_flows,
                     top_total_2019 = paste(exporter_region, "to", importer_region, sep = " ")) %>%
              select(rank, top_total_2019), by = "rank") %>%
  left_join(top_region_capture_flows_1996 %>% 
              mutate(rank = 1:top_n_regions_flows,
                     top_capture_1996 = paste(exporter_region, "to", importer_region, sep = " ")) %>%
              select(rank, top_capture_1996), by = "rank") %>%
  left_join(top_region_capture_flows_2019 %>% 
              mutate(rank = 1:top_n_regions_flows,
                     top_capture_2019 = paste(exporter_region, "to", importer_region, sep = " ")) %>%
              select(rank, top_capture_2019), by = "rank") %>%
  left_join(top_region_aquaculture_flows_1996 %>% 
              mutate(rank = 1:top_n_regions_flows,
                     top_aquaculture_1996 = paste(exporter_region, "to", importer_region, sep = " ")) %>%
              select(rank, top_aquaculture_1996), by = "rank") %>%
  left_join(top_region_aquaculture_flows_2019 %>% 
              mutate(rank = 1:top_n_regions_flows,
                     top_aquaculture_2019 = paste(exporter_region, "to", importer_region, sep = " ")) %>%
              select(rank, top_aquaculture_2019), by = "rank") 

kable(top_region_flow_table, 
      col.names = c("Rank", "All 1996", "All 2019", 
                    "Capture 1996", "Capture 2019", 
                    "Aqua 1996", "Aqua 2019"),
      caption = paste("Top", top_n_regions_flows, "country trade flows for all blue foods, capture and aquaculture in 1996 versus 2019", sep = " ")) %>%
  kable_styling()
  
```


```{r top_bilateral_flows}

bilateral_habitat_method_summary %>% 
  filter(exporter_region != "Other nei", importer_region != "Other nei") %>%
  filter(year %in% 2015:2019) %>%
  group_by(exporter_region, importer_region) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  group_by(exporter_region) %>%
  slice_max(n=2, order_by = live_weight_t)

bilateral_habitat_method_summary %>% 
  filter(exporter_region != "Other nei", importer_region != "Other nei") %>%
  filter(year %in% 2015:2019) %>%
  group_by(exporter_region, importer_region, habitat_method) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  ungroup() %>%
  group_by(exporter_region, habitat_method) %>%
  slice_max(n=1, order_by = live_weight_t)

# Regionalization trends
# Changes in trade flow volumes
bilateral_habitat_method_summary %>% 
  filter(exporter_region != "Other nei", importer_region != "Other nei",
         year %in% c(1996:2000, 2016:2020)) %>%
  mutate(year_group = case_when(
    year %in% 1996:2000 ~ "beginning", 
    year %in% 2016:2020 ~ "end")) %>%
  group_by(year_group, exporter_region, importer_region) %>% 
  summarise(live_weight_t = sum(live_weight_t)) %>%
  pivot_wider(names_from = year_group, values_from = live_weight_t, values_fill = 0) %>% 
  mutate(change = end-beginning,
         from_to = paste(exporter_region, " to ", importer_region), 
         intraregion = case_when(
           exporter_region == importer_region ~ "intraregional trade",
           exporter_region != importer_region ~ "interegional trade"
         )) %>% 
  arrange(desc(change)) %>% 
  ungroup() %>%
  ggplot(aes(x = change/1000000, y = reorder(from_to, change), color = intraregion)) +
  geom_segment(aes(x=0, xend=change/1000000, y=reorder(from_to, change), yend=reorder(from_to, change), color = intraregion)) +
  geom_point(size=3) +
  scale_y_reordered() +
  scale_color_manual(values = habitat_source_colors[c(1,4)]) +
  labs(y = "", x = "Live weight (million t)", color = "") +
  theme_minimal() +
  theme(legend.position = "bottom")

# Calculate percent of pairs with increased trade flows
bilateral_flow_change <- bilateral_habitat_method_summary %>% 
  filter(exporter_region != "Other nei", importer_region != "Other nei",
         year %in% c(1996:2000, 2016:2020)) %>%
  mutate(year_group = case_when(
    year %in% 1996:2000 ~ "beginning", 
    year %in% 2016:2020 ~ "end")) %>%
  group_by(year_group, exporter_iso3c, importer_iso3c) %>% 
  summarise(live_weight_t = sum(live_weight_t)) %>%
  pivot_wider(names_from = year_group, values_from = live_weight_t, values_fill = 0) %>% 
  mutate(change = end-beginning) %>%
  arrange(desc(change))


percent_flow_increases <- 100*(nrow(bilateral_flow_change %>% filter(change > 0)))/nrow(bilateral_flow_change)

# Calculate percent of pairs with increased trade flows by production method and habitat
bilateral_flow_change_method <- bilateral_habitat_method_summary %>% 
  filter(exporter_region != "Other nei", importer_region != "Other nei",
         year %in% c(1996:2000, 2016:2020)) %>%
  mutate(year_group = case_when(
    year %in% 1996:2000 ~ "beginning", 
    year %in% 2016:2020 ~ "end")) %>%
  group_by(year_group, exporter_iso3c, importer_iso3c, habitat_method) %>% 
  summarise(live_weight_t = sum(live_weight_t)) %>%
  pivot_wider(names_from = year_group, values_from = live_weight_t, values_fill = 0) %>% 
  mutate(change = end-beginning) %>%
  arrange(desc(change))


percent_flow_increases_marine_capture <- 100*(nrow(bilateral_flow_change_method %>% 
                                                     filter(habitat_method == "marine capture",
                                                            change > 0)))/nrow(bilateral_flow_change)
  
```

```{r LDC_patterns}
# LDC countries according to UN (https://www.un.org/development/desa/dpad/least-developed-country-category/ldcs-at-a-glance.html)
LDC_countries <- c("Afghanistan", "Angola", "Bangladesh", "Benin", "Bhutan", "Burkina Faso", "Burundi", "Cambodia", "Central African Republic", "Chad", "Comoros", "Democratic Republic of the Congo", "Djibouti", "Eritrea", "Ethiopia", "Gambia", "Guinea", "Guinea-Bissau", "Haiti", "Kiribati", "Lao People’s Dem. Republic", "Lesotho", "Liberia", "Madagascar", "Malawi", "Mali", "Mauritania", "Mozambique", "Myanmar", "Nepal", "Niger", "Rwanda", "Sao Tome and Principe", "Senegal", "Sierra Leone", "Solomon Islands", "Somalia", "South Sudan", "Sudan", "Timor-Leste", "Togo", "Tuvalu", "Uganda", "United Republic of Tanzania", "Yemen", "Zambia")

LDC_countries <- countrycode(LDC_countries, origin = "country.name", destination = "iso3c")

ldc_habitat_method_summary <- bilateral_habitat_method_summary %>%
  mutate(
    importer_ldc = case_when(
    (importer_iso3c %in% LDC_countries) ~ "LDC",
    !(importer_iso3c %in% LDC_countries) ~ "non-LDC"),
     exporter_ldc = case_when(
    (exporter_iso3c %in% LDC_countries) ~ "LDC",
    !(exporter_iso3c %in% LDC_countries) ~ "non-LDC")) %>%
  group_by(year, exporter_ldc, importer_ldc, habitat_method) %>%
  summarise(live_weight_t = sum(live_weight_t))

ldc_net_habitat_method_summary <- ldc_habitat_method_summary %>%
  ungroup() %>% 
  filter(importer_ldc == "LDC", exporter_ldc == "non-LDC") %>% 
  select(year, habitat_method, "ldc_import" = "live_weight_t") %>%
  left_join(ldc_habitat_method_summary %>%
              ungroup() %>%
              filter(importer_ldc == "non-LDC", exporter_ldc == "LDC") %>% 
              select(year, habitat_method, "ldc_export" = "live_weight_t"),
            by = c("year", "habitat_method")) %>%
  mutate(net_import = ldc_import-ldc_export,
         net_export = ldc_export-ldc_import)

ldc_net_habitat_method_summary %>%
  filter(habitat_method != "unknown") %>%
  ggplot(aes(x = year, y = net_export/1000000, color = habitat_method)) +
  geom_line() +
  scale_color_manual(values = habitat_source_colors) +
  labs(x = "", y = "Net export (million t)", color = "") +
  theme_minimal() +
  theme(legend.position = "bottom")

ldc_net_habitat_method_summary %>%
  group_by(year) %>% 
  summarise(net_export = sum(net_export))

```


## Text for MS

The top importers, exporters, and bilateral flows vary by production method, underscoring the importance of disaggregating blue food trade (Fig SX). In recent years, the marine capture and aquaculture trade networks have been dominated by Asia and Europe, and to a lesser extent, North America (Fig SX). Since 1996, the marine trade networks shifted more toward Asia and Europe, with large increases in marine capture imports and exports by Africa and large increases in marine aquaculture exports from South America and imports to North America (Fig SX). At the country level, although some countries rank among the top traders across production methods, such as China for exports and the USA for imports, many countries are only top traders for one production method. Meanwhile, inland farmed and wild production is oriented more toward domestic consumption and what is exported tends to stay within the region, particularly within Asia (Fig 2; Fig SX). Inland blue food trade is dominated by aquaculture, with the largest exports from Vietnam and China and the largest imports by the United States, Japan, and South Korea (Fig SX). 

Intraregional trade is generally stronger due to shorter transport distances, historical ties, and established regional trade agreements (REF). This pattern generally holds for blue food trade as intraregional trade is either the highest or second highest for all regions other than Oceania and South America. [Suggestions for discussion points around Oceania and South America exports?] Regional trade strengthened within Asia, Europe and Africa, where intraregional trade increased more than interegional trade. 

Since 1996, nearly all regional trade pairs increased, other than South America to Europe and Asia and within North America. The largest average annual growth increases occurred for trade within Asia, within Europe and between Europe and Asia. At the country level, `r round(percent_flow_increases, 1)`% of trade pairs increased, with the most increases for marine/inland aquaculture/capture. The declining exports from South America mirror declining marine catch over this period. [Suggestions for discussion points and context related to this?]. 

Least developed countries are net importers of blue foods [true of all production methods?] and this pattern has increased X% since 1996 (Fig SX - need to create this figure). Net imports of blue foods has previously been identified as a threat to nutrition security in these nations as [check ref for reasoning here] (REF). High net imports is also associated with risk of receiving shocks propagated through trade (Gephart et al. 2016).


## Other summary stats


# National blue food supplies

```{r consumption}

supply <- read.csv("outputs/supply.csv")

global_supply <- supply %>%
  group_by(year) %>%
  summarize(supply_no_error = sum(supply_no_error) / 1000000) %>%
  ungroup()

global_supply_1996 <- global_supply %>%
  filter(year == 1996) %>%
  pull(supply_no_error)

global_supply_2020 <- global_supply %>%
  filter(year == 2020) %>%
  pull(supply_no_error)

regional_supply <- supply %>%
  group_by(year, region) %>%
  summarize(supply_no_error = sum(supply_no_error)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(supply_no_error_total = sum(supply_no_error)) %>%
  ungroup() %>%
  mutate(percent_supply = 100 * supply_no_error / supply_no_error_total)

habitat_method_supply <- supply %>%
  group_by(year, habitat, method) %>%
  summarize(supply_no_error = sum(supply_no_error)) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(supply_no_error_total = sum(supply_no_error)) %>%
  ungroup() %>%
  mutate(percent_supply = 100 * supply_no_error / supply_no_error_total)

tmp <- habitat_method_supply %>%
  select(habitat, method, year, supply_no_error) %>%
  filter(year == 1996 | year == 2020) %>%
  mutate(year = paste("year", year, sep = "_")) %>%
  pivot_wider(names_from = year, values_from = supply_no_error) %>%
  mutate(percent_diff = 100 * (year_2020 - year_1996) / year_1996)

inland_aqua_supply_change <- tmp %>%
  filter(habitat == "inland" & method == "aquaculture") %>%
  pull(percent_diff)

marine_aqua_supply_change <- tmp %>%
  filter(habitat == "marine" & method == "aquaculture") %>%
  pull(percent_diff)

marine_cap_supply_change <- tmp %>%
  filter(habitat == "marine" & method == "capture") %>%
  mutate(percent_diff = abs(percent_diff)) %>%
  pull(percent_diff)

marine_cap_supply_percent <- habitat_method_supply %>%
  filter(year == 2020) %>%
  filter(percent_supply == max(percent_supply)) %>%
  pull(percent_supply)

method_supplies <- supply %>%
  filter(year == 2020) %>%
  group_by(method) %>%
  summarize(supply_no_error = sum(supply_no_error)) %>%
  ungroup() %>%
  mutate(total_supply = sum(supply_no_error)) %>%
  mutate(percent_supply = 100 * supply_no_error / total_supply)

regional_method_supplies <- supply %>%
  filter(year == 2020) %>%
  group_by(year, region, method) %>%
  summarize(supply_no_error = sum(supply_no_error)) %>%
  ungroup() %>%
  group_by(year, region) %>%
  mutate(region_supply = sum(supply_no_error)) %>%
  ungroup() %>%
  mutate(percent_supply = 100 * supply_no_error / region_supply) %>%
  select(region, region_supply, method, percent_supply) %>%
  pivot_wider(names_from = "method", values_from = "percent_supply")

oceania_cap_supply_percent <- regional_method_supplies %>%
  filter(region == "Oceania") %>%
  pull(capture)

asia_cap_supply_percent <- regional_method_supplies %>%
  filter(region == "Asia") %>%
  pull(capture)

cap_supply_percent <- method_supplies %>%
  filter(method == "capture") %>%
  pull(percent_supply)

asia_farmed_year <- supply %>%
  filter(region == "Asia") %>%
  group_by(year, method) %>%
  summarize(supply_no_error = sum(supply_no_error)) %>%
  ungroup() %>%
  filter(method == "capture" | method == "aquaculture") %>%
  pivot_wider(names_from = method, values_from = supply_no_error) %>%
  filter(aquaculture > capture) %>%
  filter(year == min(year)) %>%
  pull(year)


consumption_foreign <- supply %>%
  filter(year == 1996 | year == 2020) %>%
  group_by(year) %>%
  summarize(supply_foreign = sum(supply_foreign),
            supply_no_error = sum(supply_no_error)) %>%
  ungroup() %>%
  mutate(percent_supply = 100 * supply_foreign / supply_no_error)

foreign_consumption_start <- consumption_foreign %>%
  filter(year == 1996) %>%
  pull(percent_supply)

foreign_consumption_end <- consumption_foreign %>%
  filter(year == 2020) %>%
  pull(percent_supply)
  
```

## Text for MS

Since direct measurements of consumption are not collected globally, our understanding of global consumption patterns are based on apparent consumption, which generally represents the sum of production and imports minus exports and waste. Consequently, trade is central to estimating consumption and the resolution of consumption patterns is limited by the resolution of the production and trade data. By estimating species level trade, we are able to estimate apparent consumption of blue foods by species and production method. 

Globally, blue food consumption increased from `r signif(global_supply_1996, digit = 3)` (million tonnes) in 1996 to `r signif(global_supply_2020, digit = 3)` (million tonnes) in 2020. Blue food consumption also increased across all regions outside of South America, where per capita blue food consumption decreased X%, from X% in 1996 to Y% in 2020. [say this is supply included non food uses] [Double check that FMFO was excluded and discuss this pattern]. Most of the global increase was from inland and marine aquaculture, which increased by `r signif(inland_aqua_supply_change, digits = 3)` and `r signif(inland_aqua_supply_change, digits = 3)`%, respectively, over that period while marine capture consumption declined by `r signif(marine_cap_supply_change, digits = 1)`%. Capture still makes up `r signif(cap_supply_percent, digits = 2)`% of global blue food consumption and its contribution to regional blue food supplies ranges from `r signif(oceania_cap_supply_percent, digits = 2)`% in Oceania to `r signif(asia_cap_supply_percent, digits = 2)`% in Asia, where farmed consumption overtook wild consumption in `r asia_farmed_year`.

High reliance on foreign-sourced foods can pose a food security risk, motivating policies to protect domestic supplies such as the development of grain stocks and support for domestic food production (REFs). For example, high seafood import dependence in the US was used to propose a suite of policy changes to boost domestic production, including expanding aquaculture production and opening marine protected areas to fishing (Gephart et al. 2019). Since we estimate exports from domestic and foreign sources, we are able to track changes in reliance on foreign sourced products. Globally, the share of consumption that is foreign sourced has increased from `r signif(foreign_consumption_start, digits = 3)`% to `r signif(foreign_consumption_end, digits = 3)`% (Fig 3c), but patterns vary across regions with Asia and S America dominated by domestic supply, but Europe dominated by foreign supply (Fig 3d). [Add points about patterns across production methods].
	
The diversity of blue food production globally enables high diversity in blue food consumption. However, one concern about food trade is that it leads to homogenization of diets (REFS). To explore this issue, we compared the diversity (represented by the Shannon index) of production versus imports and domestic supply versus foreign supply, as well as the diversity of total supply versus total import volume (Fig 4). One notable limitation of this measure of supply diversity is that instances where production or trade is only estimated at the genus or higher level will be interpreted in the calculation as a single species. Consequently, countries with low species resolution will generally appear to have less diverse production, limiting the ability to compare supply diversity across countries.  
We find that across all regions and over time, production diversity is higher than import diversity (Fig 4a). Additionally, the diversity of domestic supply is generally higher than the diversity of foreign supply, with the domestic diversity is higher in 68% of cases across all years (Fig 4b). Nevertheless, total imports are still positively associated with supply diversity across all regions (Fig 4c). This suggests that although domestic production diversity is generally higher than the diversity of imported products, trade is still bringing in new species and increasing the diversity of products available on the market. Although imports appear to currently add to supply diversity, it is important for it not to displace domestic production diversity, particularly given that domestic production still contributes more to the diversity of the overall blue food supply.
 

## Other summary stats



